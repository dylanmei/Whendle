<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
	"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Whendle - gallery</title>
	<script src="http://ajax.googleapis.com/ajax/libs/prototype/1.6.0.3/prototype.js" type="text/javascript"></script>
	<script src="../whendle/api/whendle.js" type="text/javascript"></script>
	<script src="../whendle/api/time.js" type="text/javascript"></script>
	<script src="../whendle/api/wait.js" type="text/javascript"></script>
	<script src="../whendle/api/observable.js" type="text/javascript"></script>
	<script src="../whendle/api/tzdata.js" type="text/javascript"></script>
	<script src="../whendle/api/timezone.js" type="text/javascript"></script>
	<script src="../whendle/api/location.js" type="text/javascript"></script>
	<script src="../whendle/api/clock.js" type="text/javascript"></script>
	<script src="../whendle/api/ajax-service.js" type="text/javascript"></script>
	<script src="../whendle/api/timekeeper-service.js" type="text/javascript"></script>
	<script src="../whendle/api/timezone-service.js" type="text/javascript"></script>
	<script src="../whendle/api/gallery.js" type="text/javascript"></script>
	<script src="database-service.js" type="text/javascript"></script>
	<script src="system-service.js" type="text/javascript"></script>
	<script src="timezone-service.js" type="text/javascript"></script>
	<script>

$.trace = function() { console.log($A(arguments).join(' ')); }

document.tzone = 'America/Los_Angeles';
document.tformat = 'HH12';
document.tzpath = '../whendle/tzdata'; // firefox set ~ security.fileuri.strict_origin_policy = false
document.locations = [
	  new Whendle.Location('Seattle', 'Washington', 'United States', 47.6,-122.3)
	, new Whendle.Location('Sao Paulo', 'Sao Paulo', 'Brazil', -23.5, -46.6)
	, new Whendle.Location('London', 'England', 'United Kingdom', 51.5, -0.12)
	, new Whendle.Location('Berlin', 'Berlin', 'Germany', 52.51, 13.4)
	, new Whendle.Location('Shanghai', 'Shanghai', 'China', 31.2, 121.4)
	, new Whendle.Location('Sydney', 'New South Wales', 'Australia', -33.8, 151.2)
	, new Whendle.Location('Mexico City', 'The Federal District', 'Mexico', 19.26, -99.8)
	, new Whendle.Location('Ottawa', 'Ontario', 'Canada', 45.25, -75.43)
	, new Whendle.Location('Johannesburg', 'Gauteng', 'South Africa', -26.08, 27.54)
	, new Whendle.Location('Tokyo', 'Tokyo', 'Japan', 35.41, 139.44)
];
document.zones = {
	  'Seattle': 'America/Los_Angeles'
	, 'Sao Paulo': 'America/Sao_Paulo'
	, 'London': 'Europe/London'
	, 'Berlin': 'Europe/Berlin'
	, 'Shanghai': 'Asia/Shanghai'
	, 'Sydney': 'Australia/Sydney'
	, 'Mexico City': 'America/Mexico_City'
	, 'Ottawa': 'America/Toronto'
	, 'Johannesburg': 'Africa/Johannesburg'
	, 'Tokyo': 'Asia/Tokyo'
}
document.clocks = [
	  new Whendle.Clock(1, document.zones['Seattle'], 0, document.locations[0])
	, new Whendle.Clock(2, document.zones['Sao Paulo'], 0, document.locations[1])
	, new Whendle.Clock(3, document.zones['London'], 0, document.locations[2])
	, new Whendle.Clock(4, document.zones['Berlin'], 0, document.locations[3])
	, new Whendle.Clock(5, document.zones['Shanghai'], 0, document.locations[4])
	, new Whendle.Clock(6, document.zones['Sydney'], 0, document.locations[5])
];

document.observe('dom:loaded', function() {

	document.system = new SystemService(document.tzone, document.tformat);
	var startup = new Whendle.Observable();
	startup.run = function() {
		this.fire(Whendle.Event.status, { 'ready': true });
	}
	var timekeeper = new Whendle.TimekeeperService(document.system);
	timekeeper.setup(function() {
		document.gallery = new Gallery(startup, timekeeper, new TimezoneService(), new DatabaseService());
	});
});

//
//	Gallery
//

Gallery = Class.create(Whendle.Gallery.View, {
	initialize: function($super, startup, timekeeper, tzservice, database) {
		$super();
		this.presenter =
			new Whendle.Gallery.Presenter(this, startup, timekeeper, tzservice, database);

		this.setup();
		this.fire(Whendle.Event.loading, { 'timer': new Whendle.Timer(window) });
	},
	
	setup: function() {
		this.list = new List($('list'));
		this.list.observe(':service', this.on_clock_service.bind(this));
		this.drawer = $('drawer');
	},
	
	add: function(location) {
		this.fire(Whendle.Event.adding, { 'location': location });
	},
	
	remove: function(id) {
		var clock = document.clocks.find(function(c) {
			return c.id == id;
		});
		this.fire(Whendle.Event.removing, { 'id': id });
	},

	loaded: function(event) {
		this.list.load(event.clocks);
	},
	
	added: function(event) {
		this.list.add(event.clocks[0]);
	},
	
	removed: function(event) {
		var clock = event.clocks[0];
		this.list.remove(clock);
	},
	
	changed: function(event) {
		this.list.change(event.clocks);
	},
	
	on_clock_service: function(event) {
		$.trace('clock =', event.clock, 'service =', event.service);
	}
});

//
//	List
//
List = Class.create(Whendle.Observable, {
	initialize: function($super, container) {
		$super();
		this._container = container;
		this.setup();
	},
	
	setup: function() {
		$('appender').observe('click', this.on_appender_click.bind(this));
		$('finder').observe('click', this.on_finder_click.bind(this));
		$('formatter').observe('click', this.on_formatter_click.bind(this));
		$('drawer').observe('click', this.on_drawer_click.bind(this));
		
		var self = this;
		document.locations.each(function(l) {
			var clock = document.clocks.find(function(c) {
				return c.location == l.name;
			});
			if (!clock) {
				self.add_location_to_finder(l.name);
			}
		});	
	},
	
	on_finder_click: function(event) {
		var li = event.findElement('li');
		if (li) {
			var location = document.locations.find(function(l) {
				return l.name == li.innerHTML;
			});
			
			if (location) {
				document.gallery.add(location);
			}
		}
		$('finder').hide();
	},

	on_formatter_click: function(event) {
		var li = event.findElement('li');
		if (li) {
			var format = li.readAttribute('value');
			document.system.timeformat(format);
		}
		$('formatter').hide();
	},

	on_appender_click: function(event) {
		var link = event.findElement('.link');
		if (link) {
			
			var el = null;
			if (link.innerHTML == 'location') el = $('finder');
			if (link.innerHTML == 'format') el = $('formatter');
			if (el == null) return;
			if (el.visible()) {
				el.hide();
			}
			else {
				$$('.selection').each(function(el) { el.hide() });
				el.setStyle({
					display: 'block',
					top: (link.viewportOffset().top + 4) + 'px',
					left: (link.viewportOffset().left - 8) + 'px'
				});
			}
		}
	},
	
	on_row_click: function(id, event) {
		var next_row = event.findElement('div.-row');
		var prev_row = this._container.select('.-row').find(function(r) {
			return r.hasClassName('open');
		});
		
		if (prev_row) {
			prev_row.removeClassName('open');
		}
		if (next_row) {
			this.open_drawer(next_row);
			next_row.addClassName('open');
		}
	},
	
	get_open_row: function() {
		return this._container.select('.-row').find(function(r) {
			return r.hasClassName('open');
		});	
	},
	
	open_drawer: function(row) {
		var size = row.getDimensions();
		var pos = row.viewportOffset();
		var offset = -8;

		$('drawer')
			.show()
			.setStyle({
				top: pos.top + size.height + offset + 'px',
				left: pos.left + 'px'
			});
		$('drawer')
			.down('.buttons')
			.setStyle({
				'background-position': '0 0'
			});
	},
	
	on_drawer_click: function(event) {
		if (event.findElement('.exit')) {
			this.close_drawer();
		}
		else {
			var element = event.findElement('.buttons');
			if (!element) return;

			var row = this.get_open_row();
			
			var x = event.pointerX();
			var offset = element.viewportOffset();
			x = x - offset.left;
			var service = -1;
			if (x <= 45) service = 0;
			if (x >= 50 && x <= 95) service = 1;
			if (x >= 100 && x <= 145) service = 2;
			if (x >= 150 && x <= 195) service = 3;
			if (x >= 200 && x <= 245) service = 4;
			
			if (service != -1) {
				var clock = row.readAttribute('clock_id');
				this.launch_service(clock, service);
			}
		}
	},
	
	launch_service: function(clock, index) {
		var service = ['time', 'place', 'weather', 'photos', 'tweets'][index];
		var buttons = $('drawer')
			.down('.buttons')
			.setStyle({
				'background-position': '0 ' + (-index * 52) + 'px'
			});
		
		this.fire(':service', {id: clock, service: service});
	},
	
	close_drawer: function() {
		$('drawer').hide();
		var row = this._container.select('.-row').find(function(r) {
			return r.hasClassName('open');
		});
		if (row) row.removeClassName('open');
	},
	
	_on_append: function() {
		this.fire(':append', { 'index': this.count() });
	},
	
	_on_select: function(location) {
		this.fire(':select', { 'location': location });
	},
	
	load: function(clocks) {
		var self = this;
		var sibling = null;
		clocks.each(function(c) {
			var row = self.new_row(c);
			
			if (!sibling) {
				self._container.insert({ 'top': row });
			}
			else {
				sibling.insert({ 'after': row });
			}
			sibling = row;
		});
	},
	
	add: function(clock) {
		var row = this.new_row(clock);
		var sibling = this._container.select('.-row').last();
		if (!sibling) {
			this._container.insert({ 'top': row });
		}
		else {
			sibling.insert({ 'after': row });
		}
		this.remove_location_from_finder(clock.name);
	},
	
	change: function(clocks) {
		var rows = this._container.select('.-row');
		rows.each(function(row) {
			var id = row.readAttribute('clock_id');
			var clock = clocks.find(function(c) {	
				return c.id == id;
			});
			if (clock) {
				row.down('.-row-time').innerHTML = clock.time;
				row.down('.-row-day').innerHTML = clock.day;
			}
		});	
	},
	
	remove: function(clock) {
		var rows = this._container.select('.-row');
		rows.each(function(row) {
			var id = row.readAttribute('clock_id');
			if (id == clock_id) {
				row.remove();
			}
		});	
	},
	
	remove_location_from_finder: function(name) {
		$('finder').select('li').each(function(li) {
			$.trace(li.innerHTML, name);
			if (li.innerHTML == name) li.remove();
		});	
	},
	
	add_location_to_finder: function(name) {
		var li = new Element('li');
		li.innerHTML = name;
		$('finder').insert(li);	
	},
	
	new_row: function(clock) {
		return this.new_div('-row hbox')
			.writeAttribute('clock_id', clock.id)
			.observe('click', this.on_row_click.bind(this, clock.id))
			.insert(this.new_info(clock))
			.insert(this.new_spacer())
			.insert(this.new_time(clock));
	},

	new_info: function(clock) {
		return this.new_div('')
			.insert(this.new_div('-row-name', clock.name))
			.insert(this.new_div('-row-area', clock.place));
	},

	new_time: function(clock) {
		return this.new_div('')
			.insert(this.new_div('-row-time', clock.time))
			.insert(this.new_div('-row-day', clock.day));
	},

	new_spacer: function() {
		return this.new_div('spacer');
	},

	new_div: function(classes, content) {
		if (!classes) classes = '';
		if (Object.isArray(classes))
			classes = classes.join(' ');
		
		var element = new Element('div',
			classes.length ? { 'class': classes } : null);
		if (content)
			element.innerHTML = content;
		return element;
	}
});

	</script>
	<link href="flex-box.css" media="screen" rel="stylesheet" type="text/css" />
	<style>
.app {
	width: 320px;
	min-height: 400px;
	margin: 40px auto;
	border: 1px solid black;
	background-color: #efefef;
	
	font-family: Verdana, Arial, Helvetica, sans-serif;
}

.-row, #appender {
	width: 300px;
	padding: 10px;
	border-bottom: 1px solid #ccc;
	cursor: arrow;
}

.-row.open {
	height: 370px;
	background: url(../whendle/resources/gallery-header-open.png) 0 0 repeat-x;
}

.-row-name {
	font-size: 1.0em;
	font-weight: bold;
	text-shadow: 0 2px 1px #fff;
}
.-row-area {
	font-size: 0.8em;
}
.-row-link {
	color: blue;
}
.-row-time {
	font-size: 0.8em;
	text-align: right;
	font-weight: bold;
	text-shadow: 0 2px 1px #fff;
}

.-row-day {
	font-size: 0.8em;
	text-align: right;
}

#appender .link {
	border-bottom: 2px solid #393;
	cursor: pointer;	
}

ul.selection {
	position: absolute;
	z-index: 3;
	margin-left: 0;
	padding: 4px;
	border: 1px solid #999;
	background-color: white;
	-webkit-box-shadow: 2px 2px 2px rgba(0,0,0,0.15);	
	-moz-box-shadow: 2px 2px 2px rgba(0,0,0,0.15);	
}

ul.selection li {
	font-weight: bold;
	padding: 4px;
	color: #393;
	list-style: none;
	display: block;
	line-height: 125%;
	cursor: pointer;
}
ul.selection li.emph {
	color: #55C;
}

#drawer {
	position: absolute;
	top: 0; left: 0;
	width: 320px;
}

.buttons {
	height: 52px;
	width: 246px;
	margin: 0 0 0 10px;
	background: url(../whendle/resources/gallery-buttons.png) 0 0 no-repeat;
	
}
.exit {
	margin: 10px;
	cursor: pointer;
}


	</style>
</head>
<body>
<div class="app">
	<div id="list">
		<div id="appender">
			add a <span class="link">location</span>,
			
			change the <span class="link">format</span>
		</div>
	</div>
</div>

<div id="drawer" style="display:none;">
	<div class="hbox" style="width:100%">
		<div class="buttons"></div>
		<div class="spacer"></div>
		<div class="exit">x</div>
	</div>
</div>


<ul id="finder" class="selection" style="display:none;min-width:120px">
</ul>
<ul id="formatter" class="selection" style="display:none;min-width:80px">
	<li value="HH12">12 Hour</li>
	<li value="HH24">24 Hour</li>
</ul>

</body>
</html>
