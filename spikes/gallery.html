<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
	"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Whendle - gallery</title>
	<script src="http://ajax.googleapis.com/ajax/libs/prototype/1.6.0.3/prototype.js" type="text/javascript"></script>
	<script src="../whendle/api/whendle.js" type="text/javascript"></script>
	<script src="../whendle/api/time.js" type="text/javascript"></script>
	<script src="../whendle/api/wait.js" type="text/javascript"></script>
	<script src="../whendle/api/observable.js" type="text/javascript"></script>
	<script src="../whendle/api/tzdata.js" type="text/javascript"></script>
	<script src="../whendle/api/timezone.js" type="text/javascript"></script>
	<script src="../whendle/api/location.js" type="text/javascript"></script>
	<script src="../whendle/api/clock.js" type="text/javascript"></script>
	<script src="../whendle/api/ajax-service.js" type="text/javascript"></script>
	<script src="../whendle/api/timekeeper-service.js" type="text/javascript"></script>
	<script src="../whendle/api/timezone-service.js" type="text/javascript"></script>
	<script src="../whendle/api/gallery.js" type="text/javascript"></script>
	<script>

$.trace = function() { console.log($A(arguments).join(' ')); }

document.tzone = 'America/Los_Angeles';
document.tformat = 'HH12';
document.tzpath = '../whendle/tzdata'; // firefox set ~ security.fileuri.strict_origin_policy = false
document.locations = [
	  new Whendle.Location('Seattle', 'Washington', 'United States', 47.6,-122.3)
	, new Whendle.Location('Sao Paulo', 'Sao Paulo', 'Brazil', -23.5, -46.6)
	, new Whendle.Location('London', 'England', 'United Kingdom', 51.5, -0.12)
	, new Whendle.Location('Berlin', 'Berlin', 'Germany', 52.51, 13.4)
	, new Whendle.Location('Shanghai', 'Shanghai', 'China', 31.2, 121.4)
	, new Whendle.Location('Sydney', 'New South Wales', 'Australia', -33.8, 151.2)
	, new Whendle.Location('Mexico City', 'The Federal District', 'Mexico', 19.26, -99.8)
	, new Whendle.Location('Ottawa', 'Ontario', 'Canada', 45.25, -75.43)
	, new Whendle.Location('Johannesburg', 'Gauteng', 'South Africa', -26.08, 27.54)
	, new Whendle.Location('Tokyo', 'Tokyo', 'Japan', 35.41, 139.44)
];
document.zones = {
	  'Seattle': 'America/Los_Angeles'
	, 'Sao Paulo': 'America/Sao_Paulo'
	, 'London': 'Europe/London'
	, 'Berlin': 'Europe/Berlin'
	, 'Shanghai': 'Asia/Shanghai'
	, 'Sydney': 'Australia/Sydney'
	, 'Mexico City': 'America/Mexico_City'
	, 'Ottawa': 'America/Toronto'
	, 'Johannesburg': 'Africa/Johannesburg'
	, 'Tokyo': 'Asia/Tokyo'
}
document.clocks = [
	  new Whendle.Clock(1, document.zones['Seattle'], 0, document.locations[0])
	, new Whendle.Clock(2, document.zones['Sao Paulo'], 0, document.locations[1])
	, new Whendle.Clock(3, document.zones['London'], 0, document.locations[2])
	, new Whendle.Clock(4, document.zones['Berlin'], 0, document.locations[3])
	, new Whendle.Clock(5, document.zones['Shanghai'], 0, document.locations[4])
	, new Whendle.Clock(6, document.zones['Sydney'], 0, document.locations[5])
];

document.observe('dom:loaded', function() {

	document.system = new SystemService(document.tzone, document.tformat);
	var startup = new Whendle.Observable();
	startup.run = function() {
		this.fire(Whendle.Event.status, { 'ready': true });
	}
	var timekeeper = new Whendle.TimekeeperService(document.system);
	timekeeper.setup(function() {
		document.gallery = new Gallery(startup, timekeeper, new TimezoneService(), new DatabaseService());
	});
	prepare_appender();
});

Gallery = Class.create(Whendle.Gallery.View, {
	initialize: function($super, startup, timekeeper, tzservice, database) {
		$super();
		this.presenter =
			new Whendle.Gallery.Presenter(this, startup, timekeeper, tzservice, database);
		this.fire(Whendle.Event.loading, { 'timer': new Whendle.Timer(window) });
	},
	
	add: function(location) {
		this.fire(Whendle.Event.adding, { 'location': location });
		remove_from_finder(location.name);
	},
	
	remove: function(id) {
		var clock = document.clocks.find(function(c) {
			return c.id == id;
		});
		this.fire(Whendle.Event.removing, { 'id': id });
		if (clock)
			add_to_finder(clock.location);
	},

	loaded: function(event) {
		var list = $('list');
		var sibling = null;
		event.clocks.each(function(c) {
			row = new_row(c);
			if (!sibling) {
				list.insert({ 'top': row });
			}
			else {
				sibling.insert({ 'after': row });
			}
			sibling = row;
		});
	},
	
	added: function(event) {
		var clock = event.clocks[0];
		var list = $('list');
		var row = new_row(clock);
		var sibling = list.select('.-row').last();
		if (!sibling) {
			list.insert({ 'top': row });
		}
		else {
			sibling.insert({ 'after': row });
		}
	},
	
	removed: function(event) {
		var clock = event.clocks[0];
		remove_row(clock.id);
	},
	
	changed: function(event) {
		var list = $('list');
		var clocks = event.clocks;
		list.select('.-row').each(function(row) {
			var id = row.readAttribute('clock_id');
			var clock = clocks.find(function(c) {	
				return c.id == id;
			});
			if (clock) {
				row.down('.-row-time').innerHTML = clock.time;
				row.down('.-row-day').innerHTML = clock.day;
			}
		});
	}
});

TimezoneService = Class.create(Whendle.TimezoneService, {
	initialize: function($super, tzloader) {
		$super(null, new Whendle.TzLoader(new Whendle.AjaxService(), document.tzpath));
	},
	
	lookup: function(latitude, longitude, on_complete, on_error) {
		var location = document.locations.find(function(l) {
			return l.latitude == latitude && l.longitude == longitude;
		});

		zone = null;
		if (location) zone = document.zones[location.name];
		if (zone) {
			on_complete({ name: zone, offset: 0 });
		}
		else {
			$.trace('missing zone during lookup');
		}
	}
});

SystemService = Class.create({
	initialize: function(zone, format) {
		this._timezone = zone;
		this._timeformat = format;
		this._pref_subscription = null;
		this._time_subscription = null;
	},
	
	request: function(uri, options) {
		if (options.method == 'getPreferences') {
			var callback = options.onSuccess;
			if (options.parameters.subscribe)
				this._pref_subscription = callback;
			callback({ 'timeFormat': this._timeformat });
			
		}
		if (options.method == 'getSystemTime') {
			var callback = options.onSuccess;
			if (options.parameters.subscribe)
				this._time_subscription = callback;

			var now = Time.now()
			callback({
				'timezone': this._timezone,
				'offset': -480,
				'localtime': {
					'year': now.year(),
					'month': now.month(),
					'day': now.day(),
					'hour': now.hour(),
					'minute': now.minute(),
					'second': now.second()
				}
			});
		}
	},
	
	timeformat: function(v) {
		if (v !== undefined && v != this._timeformat) {
			this._timeformat = v;
			if (this._pref_subscription)
				this._pref_subscription({ 'timeFormat': v });
		}
		return this._timeformat;
	},
	
	timezone: function(v) {
		if (v !== undefined && v != this._timezone) {
			this._timezone = v;
			if (this._time_subscription)
				this._time_subscription({ 'timezone': v });
		}
		return this._timezone;
	}
});

DatabaseService = Class.create({
	rowset: function(statement, parameters, on_results, on_error) {
		if (statement == 'select * from clocks') {
			on_results(document.clocks);
		}
	},
	
	insert: function(statement, parameters, on_results, on_error) {
		if (statement.startsWith('insert into clocks')) {
			var id = document.clocks.length + 1;
			document.clocks.push({ 'id': id, 'location': parameters[0], 'district': parameters[1], 'country': parameters[2],
				'latitude': parameters[3], 'longitude': parameters[4], 'timezone': parameters[5] });
			on_results(id);
		}
	},
	
	remove: function(statement, parameters, on_results, on_error) {
		if (statement.startsWith('delete from clocks')) {
			var id = parameters[0];
			document.clocks = document.clocks.reject(function(c) {
				return c.id == id;
			});
			on_results(id);
		}
	}
});

function prepare_appender() {
	$('appender').observe('click', on_appender_click);
	$('finder').observe('click', on_finder_click);
	$('formatter').observe('click', on_formatter_click);
	
	document.locations.each(function(l) {
		var clock = document.clocks.find(function(c) {
			return c.location == l.name;
		});
		if (!clock) {
			add_to_finder(l.name);
		}
	});
}

function add_to_finder(location_name) {
	var li = new Element('li');
	li.innerHTML = location_name;
	$('finder').insert(li);
}

function remove_from_finder(location_name) {
	$('finder').select('li').each(function(li) {
		if (li.innerHTML == location_name) li.remove();
	});
}

function new_row(clock) {
	return new_div('-row hbox')
		.writeAttribute('clock_id', clock.id)
		.insert(new_info(clock))
		.insert(new_spacer())
		.insert(new_time(clock))
		.insert(new_controls(clock));
}

function new_info(clock) {
	return new_div('vbox')
		.insert(new_div('-row-name', clock.name))
		.insert(new_div('-row-area', clock.place));
}

function new_time(clock) {
	return new_div('vbox')
		.insert(new_div('-row-time', clock.time))
		.insert(new_div('-row-day', clock.day));
}

function new_controls(clock) {
	return new_div('vbox')
//		.insert(new_div('-row-up', '+')
//			.observe('click', on_clock_up.curry(clock.id)))
		.insert(new_div('-row-delete', 'x')
			.observe('click', on_clock_delete.curry(clock.id)));
//		.insert(new_div('-row-down', '-')
//			.observe('click', on_clock_down.curry(clock.id)));
}

function new_spacer() {
	return new_div(['spacer']);
}

function new_div(classes, content) {
	if (!classes) classes = '';
	if (Object.isArray(classes))
		classes = classes.join(' ');
		
	var element = new Element('div', { 'class': classes });
	if (content)
		element.innerHTML = content;
	return element;
}

function remove_row(clock_id) {
	var rows = $('list').select('.-row');
	rows.each(function(row) {
		var id = row.readAttribute('clock_id');
		if (id == clock_id) {
			row.remove();
		}
	});
}

function on_clock_up(clock_id) {
	$.trace('up', clock_id);
}

function on_clock_down(clock_id) {
	$.trace('down', clock_id);
}

function on_clock_delete(clock_id) {
	document.gallery.remove(clock_id);
}

function on_finder_click(event) {
	var li = event.findElement('li');
	if (li) {
		var location = document.locations.find(function(l) {
			return l.name == li.innerHTML;
		});
		
		if (location) {
			document.gallery.add(location);
		}
	}
	this.hide();
}

function on_formatter_click(event) {
	var li = event.findElement('li');
	if (li) {
		var format = li.readAttribute('value');
		document.system.timeformat(format);
	}
	this.hide();
}

function on_appender_click(event) {
	var link = event.findElement('.link');
	if (link) {
		
		var el = null;
		if (link.innerHTML == 'location') el = $('finder');
		if (link.innerHTML == 'format') el = $('formatter');
		if (el == null) return;
		if (el.visible()) {
			el.hide();
		}
		else {
			$$('.selection').each(function(el) { el.hide() });
			el.setStyle({
				display: 'block',
				top: (link.viewportOffset().top + 4) + 'px',
				left: (link.viewportOffset().left - 8) + 'px'
			});
		}
	}
}

	</script>
	<link href="flex-box.css" media="screen" rel="stylesheet" type="text/css" />
	<style>
.app {
	width: 400px;
	min-height: 400px;
	margin: 40px auto;
	border: 1px solid black;
	-webkit-border-radius: 6px;
	-webkit-box-shadow: 3px 3px 3px rgba(0,0,0,0.2);	
	-moz-border-radius: 6px;
	-moz-box-shadow: 3px 3px 3px rgba(0,0,0,0.2);	
}

.-row, #appender {
	padding: 10px;
	width: 380px;
	border-bottom: 1px solid #ccc;
	cursor: arrow;
}
.-row-name {
	display: block;
	font-size: 1.2em;
	font-weight: bold;
}
.-row-area {
	display: block;
	font-size: 0.9em;
}
.-row-link {
	color: blue;
}
.-row-time, .-row-day {
	font-size: 0.9;
	text-align: right;
}

.-row-up, .-row-delete, .-row-down {
	width: 15px;
	margin-left: 10px;
	text-align: center;
	cursor: pointer;
	font-size: .9em;
	line-height: 1em;
}

#appender .link {
	border-bottom: 2px solid #393;
	cursor: pointer;	
}

ul.selection {
	position: absolute;
	z-index: 3;
	margin-left: 0;
	padding: 4px;
	border: 1px solid #999;
	background-color: white;
	-webkit-box-shadow: 2px 2px 2px rgba(0,0,0,0.15);	
	-moz-box-shadow: 2px 2px 2px rgba(0,0,0,0.15);	
}

ul.selection li {
	font-weight: bold;
	padding: 4px;
	color: #393;
	list-style: none;
	display: block;
	line-height: 125%;
	cursor: pointer;
}
ul.selection li.emph {
	color: #55C;
}
	</style>
</head>
<body>
<div class="app">
	<div id="list">
		<div id="appender">
			add a <span class="link">location</span>,
			
			change the <span class="link">format</span>
		</div>
	</div>
</div>

<ul id="finder" class="selection" style="display:none;min-width:120px">
</ul>
<ul id="formatter" class="selection" style="display:none;min-width:80px">
	<li value="HH12">12 Hour</li>
	<li value="HH24">24 Hour</li>
</ul>

</body>
</html>
