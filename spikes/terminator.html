<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
	"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Whendle spikes - day and night</title>
	<script src="http://ajax.googleapis.com/ajax/libs/prototype/1.6.0.3/prototype.js" type="text/javascript"></script>
	<script src="../whendle/api/whendle.js" type="text/javascript"></script>
	<script src="../whendle/api/time.js" type="text/javascript"></script>
	<script src="../whendle/api/observable.js" type="text/javascript"></script>
	<script>
MAP_SURFACE = 'map-surface.jpg';
Math.K = Math.PI/180.0;
$.trace = function() { console.log($A(arguments).join(' ')); }

document.observe('dom:loaded', function() {
	wire_adjuster($('link1'), $('declination'),
		function(value) { return { 'declination': document.dec = parseFloat(value) } }
	);

	wire_adjuster($('link2'), $('hour-angle'),
		function(value) { return { 'hour_angle': (parseFloat(value) * 60) / 4 } }
	);
	
	var now = Time.now();
	now.add(Time.minutes, new Date().getTimezoneOffset());

	document.map = new SunlightMap();
	document.map.observe(':updated', on_map_updated);
	document.map.update(now);
});

function on_map_updated(event) {
	var declination = event.declination + '&deg;';
	var hour_angle = event.hour_angle / 15 >= 0 ?
		'Noon + ' + Math.round(10 * event.hour_angle / 15) / 10.0 + 'h' :
		'Noon - ' + Math.round(10 * Math.abs(event.hour_angle / 15)) / 10.0 + 'h';
	
	$('link1').next('.reading').innerHTML = declination;
	$('link2').next('.reading').innerHTML = hour_angle;
}

function on_center_change(v) {
	document.map.center(v);
}

function wire_adjuster(source, target, format_value) {
	source.observe('click', function() {
		var visible = target.visible();
		$$('.selection').each(function(el) { el.hide() });
		if (!visible) {
			target.setStyle({
				display: 'block',
				top: (this.viewportOffset().top + 4) + 'px',
				left: '8px'
			});
		}
	});
	
	target.observe('click', function(e) {
		if (e.element() == this) return;
		var v = e.element().innerHTML;
		this.hide();
		document.map.updated(format_value(v))
	});
}

SunlightCalculator = Class.create({
	declination: function(time) {
		//return -23.5;
		return -8;
	},
	
	hour_angle: function(time) {
		var hour = time.hour();
		var minute = time.minute();
		var t = hour * 60 + minute;
		return (t - 720) / 4;
	}
});

SunlightView = Class.create(Whendle.Observable, {
	initialize: function($super) {
		$super();
	},
	
	//	event = {
	//		declination: #,
	//		hour_angle: #
	//	}
	updated: function(event) {
	}	
});

SunlightPresenter = Class.create({
	initialize: function(view, calculator) {
		this.calculator = calculator;
		view.observe(':updating', this.on_updating.bind(this, view));
	},
	
	on_updating: function(view, event) {
		var t = event.time;
		if (t) {
			var result = {
				'declination': this.calculator.declination(t),
				'hour_angle': this.calculator.hour_angle(t)
			};
			view.updated(result);
		}
	}
});

SunlightMap = Class.create(SunlightView, {
	IMAGE_FILE: MAP_SURFACE,
	
	initialize: function($super) {
		$super();
		this.options = { 'center': 'map' };
		this._presenter = new SunlightPresenter(this, new SunlightCalculator());

		this.canvas = $('canvas');
		this.canvas.observe('click',
			this.on_canvas_click.bind(this));
		
		this.dec = 0;
		this.tau = 0;
		this.draw();
	},
	
	draw: function() {
		var self = this;
		var img = new Image();
		var on_ready = function() {
			self.draw_daynight(img);
		}

		img.onload = on_ready;
		img.src = this.IMAGE_FILE;
	},
	
	draw_daynight: function(map) {
		var ctx = this.canvas.getContext('2d');
		
		//this.draw_map(ctx, map);
		ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
		this.draw_sun(ctx);
		this.draw_terminator(ctx);
		this.draw_gridlines(ctx);
	},

	draw_map: function(ctx, map) {
		if (this.center() != 'sun') {
			ctx.drawImage(map, 0, 0);
		}
		else {
			var xextent = this.canvas.width;
			var xorigin = (xextent / 2);
			var xscale = (xextent / 360);
			
			var ximage = this.tau * xscale;
			
			ctx.drawImage(map, ximage, 0);
			if (ximage < 0) {
				ctx.drawImage(map, ximage + xextent, 0);
			}
			else if (ximage > 0) {
				ctx.drawImage(map, ximage - xextent, 0);
			}
		}
	},

	draw_terminator: function(ctx) {
		this.draw_terminator_path(ctx, 1, 'rgba(0, 0, 0, 0.25)');
		this.draw_terminator_path(ctx, 0, 'rgba(0, 0, 0, 0.25)');
		this.draw_terminator_path(ctx, -1, 'rgba(0, 0, 60, 0.25)');
	},
	
	draw_terminator_path: function(ctx, offset, fillStyle) {
		var xextent = this.canvas.width;
		var yextent = this.canvas.height;
		var xorigin = (xextent / 2);
		var yorigin = (yextent / 2);
		var xscale = (xextent / 360);
		var yscale = (yextent / 180);
		
		var har = this.tau;
		var dec = this.dec > 0 ?
			Math.max(0.05, this.dec) : this.dec < 0 ?
				Math.min(this.dec, -0.05) : 0.5;
		var sunpos = this.center() != 'sun' ? 180 : 180 - har;

		var xoffset = offset * (xscale / 10);
		var yoffset = offset * (xscale / 10);
		var xfx = xoffset * (23.5 / Math.abs(dec));
		var yfx = yoffset * 20;

		ctx.fillStyle = fillStyle;
		ctx.beginPath();

		for (var i = 0; i <= 360; i++) {
			
			var lng = i + har + sunpos;
			var tl = -Math.cos(lng * Math.K) / Math.tan(dec * Math.K) + xfx;
			var al = Math.atan(tl) / Math.K + yfx;
			var y = yorigin - (yscale * al);
			
			var x = (i - 180) * xscale + xorigin;

			if (i == 0) ctx.moveTo(x, y);
			else {
				ctx.lineTo(x, y);
			}
		}
		
		var ypole = dec < 0 ? 0 : yextent;
		ctx.lineTo(xextent, ypole);
		ctx.lineTo(0, ypole);
		
		ctx.fill();
	},
	
	draw_sun: function(ctx) {
		var radius = 4 * (this.canvas.height / 240);

		ctx.lineWidth = 2;
		ctx.fillStyle = 'rgba(255, 255, 100, 0.8)';
		ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';

		var x = 1;
		var y = (this.dec * (this.canvas.height / 180)) + 1;
		
		if (this.center() != 'sun') {
			x = (this.tau * (this.canvas.width / 360)) + 1;
		}

		ctx.beginPath();
		ctx.arc(
			(this.canvas.width / 2) - x,
			(this.canvas.height / 2) - y,
			radius,
			0,
			Math.PI * 2,
			false
		);
		ctx.stroke();
		ctx.fill();
	},
	
	draw_gridlines: function(ctx) {
		// equator
		ctx.lineWidth = 1;
		ctx.strokeStyle = 'rgba(255, 255, 255, 0.33)';

		ctx.beginPath();
		ctx.moveTo(0, (this.canvas.height / 2) - 1);
		ctx.lineTo(this.canvas.width, (this.canvas.height / 2) - 1);
		ctx.stroke();
	},
	
	draw_x: function(ctx, x, y) {
		ctx.lineWidth = 1;
		ctx.strokeStyle = 'rgba(255, 0, 0, 0.8)';
		
		ctx.beginPath();
		
		ctx.moveTo(x - 5, y - 5);
		ctx.lineTo(x + 5, y + 5);
		
		ctx.moveTo(x - 5, y + 5);
		ctx.lineTo(x + 5, y - 5);

		ctx.stroke();
	},
	
	on_canvas_click: function(event) {
//		$.trace('canvas', event.pointerX(), event.pointerY());
		/*
		var x = event.pointerX();
		var xscale = canvas.width / 360;
		var xorigin = canvas.width / 2;
		
		if (document.center != 'sun') {
			document.tau = (xorigin - x) / xscale;
		}
		else {
			var xoffset = xorigin - x;
			document.tau += xoffset / xscale;
		}
		
		this.fire(':click', {
			latitude: 0,
			longitude: tau
		});
		*/
	},
	
	update: function(time) {
		this.fire(':updating', { 'time': time });
	},
	
	updated: function(event) {
		var values = { 'declination': this.dec, 'hour_angle': this.tau };
		Object.extend(values, event);
		this.dec = values.declination;
		this.tau = values.hour_angle;
		this.draw();
		this.fire(':updated', values);
	},
	
	center: function(v) {
		if (v !== undefined) {
			this.options['center'] = v;
			this.draw();
		}
		return this.options['center'];
	}
});

	</script>
	<link href="flex-box.css" media="screen" rel="stylesheet" type="text/css" />
	<style>
body {
	font-family: sans-serif;
	font-size: 0.9em;
}

.hbox {
	display: -webkit-box;
	-webkit-box-orient: horizontal;
	-webkit-box-align: stretch;
 
	display: -moz-box;
	-moz-box-orient: horizontal;
	-moz-box-align: stretch;
 
	display: box;
	box-orient: horizontal;
	box-align: stretch;
}
 
.hbox > * {
	-webkit-box-flex: 0;
	-moz-box-flex: 0;
	box-flex: 0;
	display: block;
}
 
h4 {
	font-size: 0.9;
	font-style: italic;
	color: #333;
	margin: 0px;
}

#link1, #link2 {
	border-bottom: 2px solid #393;
	cursor: pointer;	
}
.reading {
	color: #333;
	font-weight: bold;
	font-style: italic;
	font-size: 80%;
}
ul.selection {
	position: absolute;
	z-index: 3;
	margin-left: 0;
	padding: 4px;
	border: 1px solid #999;
	background-color: white;
	-webkit-box-shadow: 2px 2px 2px rgba(0,0,0,0.15);	
	-moz-box-shadow: 2px 2px 2px rgba(0,0,0,0.15);	
}

ul.selection li {
	font-weight: bold;
	padding: 4px;
	color: #393;
	list-style: none;
	display: inline;
	line-height: 125%;
	cursor: pointer;
	border-left: 1px dashed #ccc;
}

ul.selection li.first {
	border-left: none;
}

ul.selection li.emph {
	color: #55C;
}


	</style>
</head>
<body>

<canvas id="canvas" width="1040" height="520"></canvas>

<div class="hbox" style="width:1040px">
	<div>
		<h4>compute the day/night terminator on a world map</h4>
		<div id="adjuster">
			adjust the <span id="link1">declination</span> <span class="reading"></span>,
			and <span id="link2">hour angle</span> <span class="reading"></span>
		</div>
	</div>
	<div style="width:50px"></div>
	<div>
		<input type="radio" name="center" id="center-map" value="map" checked="1" onchange="on_center_change($F(this))" /> <label for="center-map">center the map</label>
		&nbsp;<i>or</i>&nbsp;
		<input type="radio" name="center" id="center-sun" value="sun" onchange="on_center_change($F(this))" /> <label for="center-sun">center the sun</label>
	</div>
</div>

<ul id="declination" class="selection" style="min-width:80px;display:none;">
	<li class="first" value="HH12">23.5&deg;</li>
	<li value="HH12">20&deg;</li>
	<li value="HH12">16&deg;</li>
	<li value="HH12">12&deg;</li>
	<li value="HH12">8&deg;</li>
	<li value="HH12">4&deg;</li>
	<li value="HH12">0&deg;</li>
	<li value="HH12">-4&deg;</li>
	<li value="HH12">-8&deg;</li>
	<li value="HH12">-12&deg;</li>
	<li value="HH12">-16&deg;</li>
	<li value="HH12">-20&deg;</li>
	<li value="HH12">-23.5&deg;</li>
</ul>

<ul id="hour-angle" class="selection" style="min-width:80px;display:none;">
	<li class="first" value="HH12">-12 Hour</li>
	<li value="HH12">-10 Hour</li>
	<li value="HH12">-8 Hour</li>
	<li value="HH12">-6 Hour</li>
	<li value="HH12">-4 Hour</li>
	<li value="HH12">-2 Hour</li>
	<li value="HH12">0 Hour</li>
	<li value="HH12">2 Hour</li>
	<li value="HH12">4 Hour</li>
	<li value="HH12">6 Hour</li>
	<li value="HH12">8 Hour</li>
	<li value="HH12">10 Hour</li>
	<li value="HH12">12 Hour</li>
</ul>

</body>
</html>
