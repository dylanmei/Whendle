<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
	"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Whendle spikes - day and night</title>
	<script src="http://ajax.googleapis.com/ajax/libs/prototype/1.6.0.3/prototype.js" type="text/javascript"></script>
	<script src="../whendle/api/time.js" type="text/javascript"></script>
	<script>
$.trace = function() { console.log($A(arguments).join(' ')); }
Math.K = Math.PI/180.0;

document.observe('dom:loaded', function() {
	document.dec = -23.5;
	document.now = Time.now();
	document.tau = time_to_hour_angle(document.now);
	document.center = 'map';

	wire_adjuster($('link1'), $('declination'),
		function(value) { document.dec = value; }
	);

	wire_adjuster($('link2'), $('hour-angle'),
		function(value) { document.tau = (value * 60) / 4; }
	);

	redraw();
});

function reset_center(v) {
	document.center = v;
	redraw();
}

function time_to_hour_angle(t) {

	var offset = new Date()
		.getTimezoneOffset();
	t.add(Time.minutes, offset);
	
	var hour = t.hour();
	var minute = t.minute();
	var time = hour * 60 + minute;
	return (time - 720) / 4;
}

function wire_adjuster(source, target, on_change) {
	source.observe('click', function() {
		var visible = target.visible();
		$$('.selection').each(function(el) { el.hide() });
		if (!visible) {
			target.setStyle({
				display: 'block',
				top: (this.viewportOffset().top + 4) + 'px',
				left: '8px'
			});
		}
	});
	
	target.observe('click', function(e) {
		if (e.element() == this) return;
		var v = e.element().innerHTML;
		this.hide();
		on_change(parseFloat(v));
		redraw();
	});
}


function redraw() {
	var dec = document.dec;
	var tau = document.tau;
	var center = document.center;
	var img = new Image();
	
	var on_ready = function() {
		draw_daynight(img, center, dec, tau);
		draw_controls(dec, tau);
	}

	img.onload = on_ready;
	img.src = 'map-surface.jpg';
}

function draw_controls(dec, tau) {
	var declination = dec + '&deg;';
	var hour_angle = tau / 15 >= 0 ?
		'Noon + ' + Math.round(10 * tau / 15) / 10.0 + 'h' :
		'Noon - ' + Math.round(10 * Math.abs(tau / 15)) / 10.0 + 'h';
	
	$('link1').next('.reading').innerHTML = declination;
	$('link2').next('.reading').innerHTML = hour_angle;
}

function draw_daynight(map, center, dec, tau) {
	var canvas = $('canvas');
	var bounds = { left: 0, top: 0, right: canvas.width, bottom: canvas.height }
	var ctx = canvas.getContext('2d');
	
	draw_map(ctx, map, center, tau);
	draw_sun(ctx, center, dec, tau);
	draw_terminator(ctx, center, dec, tau);
	draw_gridlines(ctx);
}

function draw_map(ctx, map, center, tau) {
	var canvas = ctx.canvas;

	if (center != 'sun') {
		ctx.drawImage(map, 0, 0);
	}
	else {
		var xextent = canvas.width;
		var xorigin = (xextent / 2);
		var xscale = (xextent / 360);
		
		var ximage = tau * xscale;
		
		ctx.drawImage(map, ximage, 0);
		if (ximage < 0) {
			ctx.drawImage(map, ximage + xextent, 0);
		}
		else if (ximage > 0) {
			ctx.drawImage(map, ximage - xextent, 0);
		}
	}
}

function draw_gridlines(ctx) {
	var canvas = ctx.canvas;

	// equator
	ctx.lineWidth = 1;
	ctx.strokeStyle = 'rgba(255, 255, 255, 0.33)';

	ctx.beginPath();
	ctx.moveTo(0, (canvas.height / 2) - 1);
	ctx.lineTo(canvas.width, (canvas.height / 2) - 1);
	ctx.stroke();
}

function draw_sun(ctx, center, dec, tau) {
	var canvas = ctx.canvas;
	var radius = 4 * (canvas.height / 240);

	ctx.lineWidth = 2;
	ctx.fillStyle = 'rgba(255, 255, 100, 0.8)';
	ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';

	var x = 0;
	var y = (dec * (canvas.height / 180)) + 1;
	
	if (center != 'sun') {
		x = (tau * (canvas.width / 360)) + 1;
	}

	ctx.beginPath();
	ctx.arc(
		(canvas.width / 2) - x,
		(canvas.height / 2) - y,
		radius,
		0,
		Math.PI * 2,
		false
	);
	ctx.stroke();
	ctx.fill();
}

function draw_terminator(ctx, center, dec, tau) {
	draw_terminator_path(ctx, center, dec, tau, 1, 'rgba(0, 0, 60, 0.25)');
	draw_terminator_path(ctx, center, dec, tau, 0, 'rgba(0, 0, 0, 0.25)');
	draw_terminator_path(ctx, center, dec, tau, -1, 'rgba(0, 0, 0, 0.25)');
}

function draw_terminator_path(ctx, center, dec, tau, path_offset, fillStyle) {
	var canvas = ctx.canvas;
	
	var xextent = canvas.width;
	var yextent = canvas.height;
	var xorigin = (xextent / 2);
	var yorigin = (yextent / 2);
	var xscale = (xextent / 360);
	var yscale = (yextent / 180);
	
	ctx.fillStyle = fillStyle;
	ctx.beginPath();
	path_offset = path_offset * 0.25;

	var offset = center != 'sun'
		? 180 : 180 - tau;

	for (var i = 0; i <= 360; i++) {
		
		var x = (i - 180) * xscale + xorigin;
		var lng = i + tau + offset;
		var tl = -Math.cos(lng * Math.K) / Math.tan(dec * Math.K);
		var al = Math.atan(tl + path_offset) / Math.K + (path_offset * 16);
		//var al = Math.atan(tl) / Math.K;
		var y = yorigin - (yscale * al);

		if (i == 0) ctx.moveTo(x, y);
		else {
			ctx.lineTo(x, y);
		}
	}
	
	var ypole = dec < 0 ? 0 : yextent;
	ctx.lineTo(xextent, ypole);
	ctx.lineTo(0, ypole);
	
	ctx.fill();
}

function draw_point(ctx, x, y) {
	draw_x(ctx, x, y, 0);
}

function draw_anchor(ctx, x, y) {
	draw_x(ctx, x, y, 1);
}

function draw_x(ctx, x, y, i) {
	var color = ['rgba(255, 0, 0, 0.8)', 'rgba(200, 0, 255, 0.8)'][i || 0];
	ctx.lineWidth = 1;
	ctx.strokeStyle = color;
	
	ctx.beginPath();
	
	ctx.moveTo(x - 5, y - 5);
	ctx.lineTo(x + 5, y + 5);
	
	ctx.moveTo(x - 5, y + 5);
	ctx.lineTo(x + 5, y - 5);

	ctx.stroke();
}


	</script>
	<link href="flex-box.css" media="screen" rel="stylesheet" type="text/css" />
	<style>
body {
	font-family: sans-serif;
	font-size: 0.9em;
}

.hbox {
	display: -webkit-box;
	-webkit-box-orient: horizontal;
	-webkit-box-align: stretch;
 
	display: -moz-box;
	-moz-box-orient: horizontal;
	-moz-box-align: stretch;
 
	display: box;
	box-orient: horizontal;
	box-align: stretch;
}
 
.hbox > * {
	-webkit-box-flex: 0;
	-moz-box-flex: 0;
	box-flex: 0;
	display: block;
}
 
h4 {
	font-size: 0.9;
	font-style: italic;
	color: #333;
	margin: 0px;
}

#link1, #link2 {
	border-bottom: 2px solid #393;
	cursor: pointer;	
}
.reading {
	color: #333;
	font-weight: bold;
	font-style: italic;
	font-size: 80%;
}
ul.selection {
	position: absolute;
	z-index: 3;
	margin-left: 0;
	padding: 4px;
	border: 1px solid #999;
	background-color: white;
	-webkit-box-shadow: 2px 2px 2px rgba(0,0,0,0.15);	
	-moz-box-shadow: 2px 2px 2px rgba(0,0,0,0.15);	
}

ul.selection li {
	font-weight: bold;
	padding: 4px;
	color: #393;
	list-style: none;
	display: inline;
	line-height: 125%;
	cursor: pointer;
	border-left: 1px dashed #ccc;
}

ul.selection li.first {
	border-left: none;
}

ul.selection li.emph {
	color: #55C;
}


	</style>
</head>
<body>

<canvas id="canvas" width="1040" height="520"></canvas>

<div class="hbox" style="width:1040px">
	<div>
		<h4>compute the day/night terminator on a world map</h4>
		<div id="adjuster">
			adjust the <span id="link1">declination</span> <span class="reading"></span>,
			and <span id="link2">hour angle</span> <span class="reading"></span>
		</div>
	</div>
	<div style="width:50px"></div>
	<div>
		<input type="radio" name="center" id="center-map" value="map" checked="1" onchange="reset_center($F(this))" /> <label for="center-map">center the map</label>
		&nbsp;<i>or</i>&nbsp;
		<input type="radio" name="center" id="center-sun" value="sun" onchange="reset_center($F(this))" /> <label for="center-sun">center the sun</label>
	</div>
</div>

<ul id="declination" class="selection" style="min-width:80px;display:none;">
	<li class="first" value="HH12">23.5&deg;</li>
	<li value="HH12">20&deg;</li>
	<li value="HH12">16&deg;</li>
	<li value="HH12">12&deg;</li>
	<li value="HH12">8&deg;</li>
	<li value="HH12">4&deg;</li>
	<li value="HH12">0&deg;</li>
	<li value="HH12">-4&deg;</li>
	<li value="HH12">-8&deg;</li>
	<li value="HH12">-12&deg;</li>
	<li value="HH12">-16&deg;</li>
	<li value="HH12">-20&deg;</li>
	<li value="HH12">-23.5&deg;</li>
</ul>

<ul id="hour-angle" class="selection" style="min-width:80px;display:none;">
	<li class="first" value="HH12">-12 Hour</li>
	<li value="HH12">-10 Hour</li>
	<li value="HH12">-8 Hour</li>
	<li value="HH12">-6 Hour</li>
	<li value="HH12">-4 Hour</li>
	<li value="HH12">-2 Hour</li>
	<li value="HH12">0 Hour</li>
	<li value="HH12">2 Hour</li>
	<li value="HH12">4 Hour</li>
	<li value="HH12">6 Hour</li>
	<li value="HH12">8 Hour</li>
	<li value="HH12">10 Hour</li>
	<li value="HH12">12 Hour</li>
</ul>

</body>
</html>
