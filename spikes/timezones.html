<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
	"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Whendle - time</title>
	<script src="http://ajax.googleapis.com/ajax/libs/prototype/1.6.0.3/prototype.js" type="text/javascript"></script>
	<script src="../whendle/api/whendle.js" type="text/javascript"></script>
	<script src="../whendle/api/time.js"></script>
	<script src="../whendle/api/timezone.js"></script>
	<script src="../whendle/api/tzdata.js"></script>
	<script src="../whendle/api/ajax-service.js"></script>
	<script src="../whendle/api/timezone-service.js"></script>
	<script>
document.tzpath = '../whendle/tzdata'; // copy to ./tzdata for mozilla
document.observe('dom:loaded', function() {

	prepare_date();
	
	$$('.links li').each(function(li) {
		li.observe('click', function() { load_zone(li.innerHTML); });
	});
});

function prepare_date() {
	$('now').down('.year')
		.observe('click', function() {
			var visible = $('years').visible();
			$$('.selection').each(function(el) { el.hide() });
			if (!visible) {
				$('years').setStyle({
					display: 'block',
					top: (this.viewportOffset().top + 4) + 'px',
					left: (this.viewportOffset().left - 8) + 'px'
				});
			}
		});
		
	$('now').down('.month')
		.observe('click', function() {
			var visible = $('months').visible();
			$$('.selection').each(function(el) { el.hide() });
			if (!visible) {
				$('months').setStyle({
					display: 'block',
					top: (this.viewportOffset().top + 4) + 'px',
					left: (this.viewportOffset().left - 8) + 'px'
				});
			}
		});

	$('now').down('.day')
		.observe('click', function() {
			var visible = $('days').visible();
			$$('.selection').each(function(el) { el.hide() });
			if (!visible) {
				$('days').setStyle({
					display: 'block',
					top: (this.viewportOffset().top + 4) + 'px',
					left: (this.viewportOffset().left - 8) + 'px'
				});
			}
		});
	
	$('years').observe('click', function(e) {
		if (e.srcElement == this) return;
		var date = $.date.copy();
		date.setFullYear(parseInt(e.srcElement.innerHTML, 10));
		apply_date(date);
	});

	$('months').observe('click', function(e) {
		if (e.srcElement == this) return;
		var date = $.date.copy();
		date.setMonth({ 'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5, 'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11 }[e.srcElement.innerHTML]);
		apply_date(date);
	});

	$('days').observe('click', function(e) {
		if (e.srcElement == this) return;
		var date = $.date.copy();
		date.setDate(parseInt(e.srcElement.innerHTML, 10));
		apply_date(date);
	});

	apply_date(new Date());
}

function apply_date(date) {
	$$('.selection').each(function(el) { el.hide() });
	if (!date) {
		date = $.date;
	}
	else {
		$.date = new Date(date.getFullYear(), date.getMonth(), date.getDate(), date.getHours(), date.getMinutes());
		var now = /(\d+)-(\d+)-(\d+)\s(\S+)/.exec($.date.Local);
		$('now').down('.year').update(now[1]);
		$('now').down('.month').update(now[2]);
		$('now').down('.day').update(now[3]);
		$('now').down('.time').update(now[4]);
	}
	
	if (!$.timezone) return;
	var zone = $.timezone.zone(date);
	$$('.z-row').each(function(row) {
		if (row.down('div', 1).innerText == zone.GMTOFF &&
			row.down('div', 2).innerText == zone.RULES &&
			row.down('div', 3).innerText == zone.FORMAT &&
			row.down('div', 4).innerText == (zone.UNTIL || ''))
		{
			$('z-marker').setStyle({
				display: 'block',
				height: row.getHeight() + 'px',
				top: row.viewportOffset().top + 'px'
			});
		}
	});

	var rule = $.timezone.rule(zone.RULES, $.date);
	if (rule) {
		$$('.r-row').each(function(row) {
			if (row.down('div', 1).innerText == rule.FROM &&
				row.down('div', 2).innerText == rule.TO &&
				row.down('div', 4).innerText == rule.IN &&
				row.down('div', 5).innerText == rule.ON &&
				row.down('div', 6).innerText == rule.AT)
			{
				$('r-marker').setStyle({
					display: 'block',
					height: row.getHeight() + 'px',
					top: row.viewportOffset().top + 'px'
				});		
			}
		});
	}
}

function load_zone(name) {
	var ajax = new Whendle.AjaxService();
	var loader = new Whendle.TzLoader(ajax, document.tzpath);

	$.timezone = null;
	$('z-marker').hide();
	$('r-marker').hide();
	$('z').childElements().each(function(el) {
		if (!el.hasClassName('sticky'))
			el.remove();
	});
	
	new Whendle.TimezoneService(ajax, loader).load(
		name,
		function(timezone) {
			$.timezone = timezone;
			zones = timezone._zones;
			zones.each(function(z) {
				var row = new_zone_row(z);

				if (!not_a_rule(z.RULES)) {
					row.setStyle({'cursor': 'pointer'})
						.observe('click', load_rule.curry(z, row))
						.observe('mouseover', function() { this.addClassName('z-hover'); })
						.observe('mouseout', function() { this.removeClassName('z-hover'); });
				}
				
				$('z').insert(row);
				$('z').insert(new_div('z-divider'));
			});
			apply_date.defer();
		},
		function(e) { $.trace('error', Object.toJSON(e)); }
	);
}

function not_a_rule(rule_name) {
	return !Object.isString(rule_name) || rule_name.match(/[A-Za-z_]/g) == null;
}

function load_rule(zone, row) {
	var collapse = row.hasClassName('z-active');
	$('z').childElements().each(function(el) {
		if (el.hasClassName('r-divider') ||
			el.hasClassName('r-row') ||
			el.hasClassName('r-header'))
		{
			el.remove();
		}
		if (el.hasClassName('z-active')) {
			el.removeClassName('z-active');
		}
	});
	if (collapse) return;
	row.addClassName('z-active');
	
	var new_row = new_div(['r-divider', 'dotted']);
	row.insert({ after: new_row });
	row = new_row;
	new_row = new_rule_header();
	row.insert({ after: new_row });
	
	var rules = $.timezone._rules;
	rules.each(function(r) {
		if (r.NAME == zone.RULES) {
			row = new_row;
			new_row = new_div('r-divider');
			row.insert({ after: new_row });

			row = new_row;
			new_row = new_rule_row(r);
			row.insert({ after: new_row });
		}
	});
	apply_date.defer();
}

function new_zone_row(zone) {
	return new_div(['z-row', 'hbox'])
		.insert(new_div('z-name', zone.NAME))
		.insert(new_div('z-offset', zone.GMTOFF))
		.insert(new_div('z-rules', zone.RULES))
		.insert(new_div('z-format', zone.FORMAT))
		.insert(new_div('z-until', zone.UNTIL));
}

function new_rule_header() {
	return new_div(['r-header', 'hbox'])
		.insert(new_div('r-name', 'RULE'))
		.insert(new_div('r-from', 'FROM'))
		.insert(new_div('r-to', 'TO'))
		.insert(new_div('r-in', 'IN'))
		.insert(new_div('r-on', 'ON'))
		.insert(new_div('r-at', 'AT'))
		.insert(new_div('r-save', 'SAVE'))
		.insert(new_div('r-letters', 'LETTERS'));
}

function new_rule_row(rule) {
	return new_div(['r-row', 'hbox'])
		.insert(new_div('r-name', rule.NAME))
		.insert(new_div('r-from', rule.FROM))
		.insert(new_div('r-to', rule.TO))
		.insert(new_div('r-in', rule.IN))
		.insert(new_div('r-on', rule.ON))
		.insert(new_div('r-at', rule.AT))
		.insert(new_div('r-save', rule.SAVE))
		.insert(new_div('r-letters', rule.LETTERS));
}

function new_div(classes, content) {
	if (!classes) classes = '';
	if (Object.isArray(classes))
		classes = classes.join(' ');
		
	var element = new Element('div', { 'class': classes });
	if (content)
		element.innerHTML = content;
	return element;
}

$.trace = function() {
	var args = $A(arguments);
	var s = args.join(' ');
	window.counter = window.counter + 1 || 1;
	var counter = window.counter.toPaddedString(3);
	$('trace').innerHTML += counter + '-> ' + s + '<br />';
}
	</script>
	<link href="flex-box.css" media="screen" rel="stylesheet" type="text/css" />
	<style>
body {
	font-family: sans-serif;
	font-size: 0.9em;
}

#z {
	width: 600px;
	-webkit-box-shadow: 3px 3px 3px rgba(0,0,0,0.25);	
	-moz-box-shadow: 3px 3px 3px rgba(0,0,0,0.25);	
}

#z div {
	overflow: hidden;
	text-overflow: ellipsis;
}

.z-row, .z-header, .z-empty {
	border-right: 1px solid #999;
}
.z-header {
	background-color: #eee;
}
.z-active {
	background-color: #eef;
}
.z-hover {
	background-color: #ccf;
}
.z-divider, .r-divider {
	border-top: 1px solid #999;
}
.r-divider.dotted {
	border-top: 1px dotted #999;
}
.z-name, .z-offset, .z-rules, .z-format, .z-until, .z-empty,
.r-name, .r-from, .r-to, .r-in, .r-on, .r-at, .r-save, .r-letters {
	border-left: 1px solid #999;
	padding: 2px 0 2px 2px;
}
.r-name {
	padding: 2px 0 2px 6px;
}

.z-name, .z-until {
	width: 180px;
}
.z-offset, .z-rules, .z-format {
	width: 80px;
}
.z-empty {
	font-style: italic;
}

.r-name, .r-from, .r-to, .r-in, .r-on, .r-at, .r-save, .r-letters {
	width: 70px;
}

.r-row, .r-header {
	border-right: 1px solid #999;
	background-color: #ffe;
}
.r-header {
	background-color: #eed;
}
.links {
	margin-top: 0;
	padding-top: 0;
	margin-left: 0;
	padding-left: 0;
}
.links li {
	color: #393;
	font-size: 80%;
	font-weight: bold;
	text-decoration: underline;
	line-height: 140%;
	cursor: pointer;
	list-style: none;
}
.when {
	font-style: italic;
	margin-left: -8px;
	padding-left: 2px;
	border-left: 8px solid red;
}
#now {
	font-style: normal;
	font-weight: bold;
}
#now .year, #now .month, #now .day {
	border-bottom: 2px solid #393;
	cursor: pointer;
}

#z-marker, #r-marker {
	display: none;
	position: absolute;
	z-index: 2;
	top: 0;
	left: 0;
	height: 8px;
	width: 8px;
	background-color: red;
}

ul.selection {
	position: absolute;
	z-index: 3;
	margin-left: 0;
	padding: 4px;
	border: 1px solid #999;
	background-color: white;
	-webkit-box-shadow: 2px 2px 2px rgba(0,0,0,0.15);	
	-moz-box-shadow: 2px 2px 2px rgba(0,0,0,0.15);	
}

ul.selection li {
	font-weight: bold;
	padding: 4px;
	color: #393;
	list-style: none;
	display: inline;
	line-height: 125%;
	cursor: pointer;
}
	</style>
</head>
<body>

<p class="when">
	active time:
	<span id="now">
		<span class="year"></span>-<span class="month"></span>-<span class="day"></span> <span class="time"></span>
	</span>
</p>

<div class="hbox" style="width:100%;">
	<div>
		<div id="z">
			<div class="z-divider sticky"></div>
			<div class="z-header sticky hbox">
				<div class="z-name">ZONE</div>
				<div class="z-offset">GMTOFF</div>
				<div class="z-rules">RULES</div>
				<div class="z-format">FORMAT</div>
				<div class="z-until">UNTIL</div>
			</div>
			<div class="z-divider sticky"></div>
			<div class="z-empty">choose a timezone...</div>
			<div class="z-divider"></div>
		</div>
	</div>
	<div class="spacer"></div>
	<div>
		<ul class="links">
			<li>Africa/Algiers</li>
			<li>America/Argentina/Buenos_Aires</li>
			<li>America/Goose_Bay</li>
			<li>America/Los_Angeles</li>
			<li>America/Sao_Paulo</li>
			<li>Antarctica/Palmer</li>
			<li>Asia/Gaza</li>
			<li>Asia/Shanghai</li>
			<li>Asia/Tbilisi</li>
			<li>Australia/Adelaide</li>
			<li>Europe/Istanbul</li>
			<li>Europe/Brussels</li>
			<li>Europe/Warsaw</li>
		</ul>
		<input type="text" id="text" value="" /><input type="button" value="timezone" onclick="load_zone($F('text'))" />
	</div>
</div>

<div id="z-marker">&nbsp;</div>
<div id="r-marker">&nbsp;</div>
<ul id="years" class="selection" style="width:290px;">
	<li>2013</li>
	<li>2012</li>
	<li>2011</li>
	<li>2010</li>
	<li>2009</li>
	<li>2008</li>
	<li>2007</li>
	<li>2006</li>
	<li>2005</li>
	<li>2004</li>
	<li>2003</li>
	<li>2002</li>
	<li>2001</li>
	<li>2000</li>
	<li>1999</li>
	<li>1998</li>
	<li>1997</li>
	<li>1996</li>
	<li>1995</li>
	<li>1994</li>
	<li>1993</li>
	<li>1992</li>
	<li>1991</li>
	<li>1990</li>
	<li>1989</li>
	<li>1988</li>
	<li>1987</li>
	<li>1986</li>
	<li>1985</li>
	<li>1984</li>
	<li>1983</li>
	<li>1982</li>
	<li>1981</li>
	<li>1980</li>
	<li>1979</li>
	<li>1978</li>
	<li>1977</li>
	<li>1976</li>
	<li>1975</li>
	<li>1974</li>
	<li>1973</li>
	<li>1972</li>
	<li>1971</li>
	<li>1970</li>
	<li>1969</li>
	<li>1968</li>
	<li>1967</li>
	<li>1966</li>
	<li>1965</li>
	<li>1964</li>
	<li>1963</li>
	<li>1962</li>
	<li>1961</li>
	<li>1960</li>
	<li>1959</li>
	<li>1958</li>
	<li>1957</li>
	<li>1956</li>
	<li>1955</li>
	<li>1954</li>
	<li>1953</li>
	<li>1952</li>
	<li>1951</li>
	<li>1950</li>
	<li>1949</li>
	<li>1948</li>
	<li>1947</li>
	<li>1946</li>
	<li>1945</li>
	<li>1944</li>
	<li>1943</li>
	<li>1942</li>
	<li>1941</li>
	<li>1940</li>
	<li>1939</li>
	<li>1938</li>
	<li>1937</li>
	<li>1936</li>
	<li>1935</li>
	<li>1934</li>
	<li>1933</li>
	<li>1932</li>
	<li>1931</li>
	<li>1930</li>
	<li>1929</li>
	<li>1928</li>
	<li>1927</li>
	<li>1926</li>
	<li>1925</li>
	<li>1924</li>
	<li>1923</li>
	<li>1922</li>
	<li>1921</li>
	<li>1920</li>
	<li>1919</li>
	<li>1918</li>
	<li>1917</li>
	<li>1916</li>
	<li>1915</li>
	<li>1914</li>
	<li>1913</li>
	<li>1912</li>
	<li>1911</li>
	<li>1910</li>
	<li>1909</li>
	<li>1908</li>
	<li>1907</li>
	<li>1906</li>
	<li>1905</li>
	<li>1904</li>
	<li>1903</li>
	<li>1902</li>
	<li>1901</li>
	<li>1900</li>
</ul>
<ul id="months" class="selection" style="width:160px;">
	<li>Jan</li>
	<li>Feb</li>
	<li>Mar</li>
	<li>Apr</li>
	<li>May</li>
	<li>Jun</li>
	<li>Jul</li>
	<li>Aug</li>
	<li>Sep</li>
	<li>Oct</li>
	<li>Nov</li>
	<li>Dec</li>
</ul>
<ul id="days" class="selection" style="width:290px;">
	<li>&nbsp;1</li>
	<li>&nbsp;2</li>
	<li>&nbsp;3</li>
	<li>&nbsp;4</li>
	<li>&nbsp;5</li>
	<li>&nbsp;6</li>
	<li>&nbsp;7</li>
	<li>&nbsp;8</li>
	<li>&nbsp;9</li>
	<li>10</li>
	<li>11</li>
	<li>12</li>
	<li>13</li>
	<li>14</li>
	<li>15</li>
	<li>16</li>
	<li>17</li>
	<li>18</li>
	<li>19</li>
	<li>20</li>
	<li>21</li>
	<li>22</li>
	<li>23</li>
	<li>24</li>
	<li>25</li>
	<li>26</li>
	<li>27</li>
	<li>28</li>
	<li>29</li>
	<li>30</li>
	<li>31</li>
</ul>


<tt id="trace">
</tt>
</body>
</html>


