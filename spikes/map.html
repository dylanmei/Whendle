<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
	"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Whendle - map</title>
<!--
	<script src="http://ajax.googleapis.com/ajax/libs/prototype/1.6.0.3/prototype.js" type="text/javascript"></script>
-->
	<script src="prototype.js" type="text/javascript"></script>
	<script>
$.trace = function() { console.log($A(arguments).join(' ')); }

Resources = {
	SURFACE_FILE: 'map-surface.png'
};

Math.K = Math.PI/180.0;

Time = {
	angle_converter: {
		convert: function(time) {
			var DEGS_PER_MIN = 6.0;
			var DEGS_PER_HOUR = 30.0;
			var MIN_PER_HOUR = 60.0;

			var hour = time.hour;
			var minute = time.minute;

			return {
				hour: (hour % 12 * DEGS_PER_HOUR) + (minute * (DEGS_PER_HOUR / MIN_PER_HOUR)),
				minute: minute * DEGS_PER_MIN
			}
		}
	}
}

document.observe('dom:loaded', function() {
	$.view = new View();
});

View = Class.create({
	initialize: function() {
		this.setup();
	},
	
	setup: function() {
		this._map = new Map();
		this._map.go(Places.seattle.location());

		for (var x in Places)
			this._map.mark(Places[x].id, Places[x].name, { hour: 7, minute: 22 }, { x: Places[x].latitude, y: Places[x].longitude });
	}
});

Place = Class.create({
	initialize: function(id, name, longitude, latitude) {
		this.id = id;
		this.name = name;
		this.longitude = longitude;
		this.latitude = latitude;
	},
	
	location: function() {
		return {
			  x: this.longitude
			, y: this.latitude
		}
	}
});

var Places = {
	  seattle: new Place(0, 'Seattle', -122.3, 47.6)
//	, sao_paulo: new Place(1, 'Sao Paulo', -46.6, -23.5)
//	, london: new Place(2, 'London', -0.12, 51.5)
//	, berlin: new Place(3, 'Berlin', 13.4, 52.51)
//	, shanghai: new Place(4, 'Shanghai', 121.4, 31.2)
//	, sydney: new Place(5, 'Sydney', 151.2, -33.8)
//	, ottawa: new Place(6, 'Ottawa', -75.43, 45.25)
//	, johannesburg: new Place(7, 'Johannesburg', 28.045556, -26.204444)
//	, tokyo: new Place(8, 'Tokyo', 139.44, 35.41)
//	, abu_dhabi: new Place(9, 'Abu Dhabi', 54.366667, 24.466667)
//	, tafuna: new Place(10, 'Tafuna', -170.72, -14.335833)
	, wellington: new Place(10, 'Wellington', 174.777222, -41.288889)
	, reykjavik: new Place(11, 'Reykjavik', -21.902479, 64.137383)
}

Map = Class.create({
	SURFACE_FILE: Resources.SURFACE_FILE,
	
	initialize: function() {
		this.marks = [];
		this.longitude = this.latitude = 0;
		this.tau = -132.75;
		this.dec = -23.5;

		this.canvas = $('core-canvas');
		this.seam = $('seam-canvas');
		
		this.prepare_canvas();
		this.attach_events();

		this.load_resources();
	},
	
	prepare_canvas: function() {
		area = {
			  x: 1040
			, y: 520
		}
	
		this.canvas.width = area.x;
		this.canvas.height = area.y;
		this.canvas.setStyle({
			  position: 'fixed'
			, top: '0'
			, left: '0'
		});

		this.seam.width = area.x;
		this.seam.height = area.y;
		this.seam.setStyle({
			  position: 'fixed'
			, top: '0'
			, left: this.seam.width + 'px'
		});
	},
	
	attach_events: function() {
		document.observe('mousedown',
			this.down_handler = this.on_mousedown.bind(this));
		document.observe('mouseup',
			this.up_handler = this.on_mouseup.bind(this));
		document.observe('click',
			this.click_handler = this.on_click.bind(this));
	},

	load_resources: function() {
		var self = this;

		var surface = new Image();
		surface.onload = function() {
			self.surface = surface;
			self.redraw();
		};

		surface.src = this.SURFACE_FILE;
	},

	mark: function(key, text, time, location) {
		var sprite = this.marks.find(function(s) {
			return s.key == key;
		});
		
		if (!sprite) {
			sprite = new Map_Sprite(key);
			this.marks.push(sprite);
		}
		
		sprite
			.text(text)
			.time(time)
			.location(location);
		
		//this.redraw();
		this.move_sprites();
	},
	
	go: function(coordinate) {
		this.longitude = coordinate.x;
		this.latitude = coordinate.y;
		
		var position = this.coordinate_to_point(coordinate);
		var viewport = this.viewport();
		
		var seam_x = this.canvas.width;
		var canvas_x = (viewport.x / 2) - position.x;
		
		if (canvas_x > 0) {
			seam_x = canvas_x - this.canvas.width;
		}
		
		if (canvas_x + this.canvas.width < viewport.x) {
			seam_x = canvas_x + this.canvas.width;
		}
		
		this.move_canvas(this.canvas, canvas_x, 0);
		this.move_canvas(this.seam, seam_x, 0);
		this.move_sprites();
	},
	
	move_canvas: function(canvas, x, y) {
		canvas.setStyle({
			  left: x + 'px'
			, top: y + 'px'
		});
	},
	
	move_sprites: function() {
		var scale = this.scale();
		var extent = this.extent();
		var viewport = this.viewport();
		var offset = this.map_offset();
		
//		$.trace('offset', Object.toJSON(this.map_offset()));
		this.marks.each(function(s) {
			var where = {
				  x: offset.x + (extent.x / 2) + (s.longitude * scale.x)
				, y: offset.y + (extent.y / 2) + (s.latitude * -scale.y)
			}		
			
			var size = s.size();
			if (where.x + (size.x / 2) < 0) {
				where.x += extent.x;
			}
			else if (where.x - size.x / 2 > viewport.x) {
				where.x -= extent.x;
			}

			s.move(where);
		});
	},
	
	extent: function(v) {
		return {
			x: this.canvas.width,
			y: this.canvas.height
		}
	},
	
	viewport: function(v) {
		return {
			  x: window.innerWidth
			, y: window.innerHeight
		}

	},
	
	location: function() {
		return {
			  x: this.longitude
			, y: this.constrain_latitude_to_viewport(this.latitude)
		}
	},

	scale: function() {
		var extent = this.extent();
		return {
			x: extent.x / 360,
			y: extent.y / 180
		}
	},
	
	constrain_latitude_to_viewport: function(value) {
		var underflow =
			this.extent().y -
			this.viewport().y;
		underflow /= this.scale().y;
		
		var min = -underflow / 2;
		var max = underflow / 2;

		var latitude = value;
		if (latitude < min)
			latitude = min;
		if (latitude > max)
			latitude = max;
		
		return latitude;
	},

	redraw: function() {
		if (this.surface)
			this.draw();
	},
	
	draw: function() {
		var ctx = this.canvas.getContext('2d');
		this.draw_surface(ctx);
		this.draw_terminator(ctx);
		this.draw_places(ctx);

		this.draw_seam_canvas(ctx.canvas,
			this.seam.getContext('2d'));
	},
	
	draw_surface: function(ctx) {
		var extent = this.extent();
		ctx.drawImage(
			this.surface,
			0, 0, this.surface.width, this.surface.height,
			0, 0, extent.x, extent.y
		);
	},

	draw_terminator: function(ctx) {
		var extent = this.extent();
		var scale = this.scale();
		var xorigin = (extent.x / 2);
		var yorigin = (extent.y / 2);

		ctx.beginPath();

		for (var i = 0; i <= 360; i++) {
			var x = (i - 180) * scale.x + xorigin;
			var lng = i + this.tau + 180;
			var tl = -Math.cos(lng * Math.K) / Math.tan(this.dec * Math.K);
			var al = Math.atan(tl) / Math.K;
			var y =  yorigin - (scale.y * al);

			if (i == 0) ctx.moveTo(x, y);
			else {
				ctx.lineTo(x, y);
			}
		}

		var ypole = this.dec < 0 ? 0 : extent.y;
		ctx.lineTo(extent.x, ypole);
		ctx.lineTo(0, ypole);
		ctx.closePath();
		
		ctx.fillStyle = 'rgba(0, 0, 0, 0.25)';
		ctx.fill();
	},
	
	draw_places: function(ctx) {
		var self = this;
		var origin = {
			  x: this.extent().x / 2
			, y: this.extent().y / 2
		}

		ctx.save();
		ctx.translate(origin.x, origin.y);
		this.marks.each(function(p) {
			self.draw_place(ctx, p);
		});
		
		// todo: draw overlaps
		ctx.restore();
	},
	
	draw_place: function(ctx, place) {
		var scale = this.scale();
		
		var origin = {
			  x: place.longitude * scale.x
			, y: place.latitude * -scale.y
		};
		
		ctx.strokeStyle = 'red';
		ctx.lineWidth = 2;
		ctx.beginPath();
		ctx.arc(origin.x, origin.y, 4, 0, Math.PI * 2, true);
		ctx.stroke();
	},

	draw_seam_canvas: function(canvas, ctx) {
		ctx.drawImage(canvas, 0, 0);
	},
	
	map_offset: function() {
		var location = this.location();
		return this.translate_point(
			this.coordinate_to_point({
				  x: location.x
				, y: location.y
			})
		);
	},
	
	coordinate_offset: function(coordinate) {
		return this.point_offset(
			this.coordinate_to_point({
				  x: coordinate.x
				, y: coordinate.y
			})
		);
	},
	
	point_offset: function(point) {
		var offset = this.map_offset();
		return {
			  x: point.x + offset.x
			, y: point.y + offset.y
		}
	},
	
	translate_point: function(point) {
		var viewport = this.viewport();
		var offset = {
			  x: 0
			, y: 0
		};
		
		offset.x -= point.x - (viewport.x / 2);
		offset.y += viewport.y / 2 - point.y;
		return offset;	
	},
	
	coordinate_to_point: function(coordinate) {
		var scale = this.scale();
		var extent = this.extent();
		var point = {
			  x: extent.x / 2
			, y: extent.y / 2
		};
		
		point.x += coordinate.x * scale.x;
		point.y -= coordinate.y * scale.y;
		return point;	
	},

	point_to_coordinate: function(point) {
		var extent = this.extent();
		var scale = this.scale();
		var offset = this.map_offset();
		
		var coordinate = {
			  x: (point.x - offset.x) - extent.x / 2
			, y: (offset.y - point.y) + extent.y / 2
		}
		
		coordinate.x /= scale.x;
		coordinate.y /= scale.y;
		
		return coordinate;
	},
	
	on_mousedown: function(event) {
		if (event.findElement('canvas') != null) {
			var drag_start_location = this.location();
			var drag_start_point = {
				  x: event.pointerX()
				, y: event.pointerY()
			};

			document.observe('mousemove', this.drag_handler =
				this.on_drag.bind(this, drag_start_location, drag_start_point));
		}
	},
	
	on_mouseup: function(event) {
		if (this.drag_handler) {
			document.stopObserving('mousemove', this.drag_handler);
			this.drag_handler = null;
		}
	},
	
	on_drag: function(drag_start_location, drag_start_point, event) {
		var current_offset = {
			  x: event.pointerX() - drag_start_point.x
			, y: event.pointerY() - drag_start_point.y		
		};
		
		var scale = this.scale();
		var coordinate_offset = {
			  x: current_offset.x / scale.x
			, y: current_offset.y / scale.y
		};
		
		var go = {
			  x: drag_start_location.x - coordinate_offset.x
			, y: drag_start_location.y + coordinate_offset.y
		}
		
		if (go.x < -180) {
			go.x = 180 + go.x % 180;
		}
		else if (go.x > 180) {
			go.x = -180 + go.x % 180;
		}
		
		this.go(go);
	},
	
	on_click: function(event) {
		var click = {
			  x: event.pointerX()
			, y: event.pointerY()
		};
	
		for (var i = 0; i < this.marks.length; i++) {
			var s = this.marks[i];
			if (s.hit(click)) {
				$.trace(s.text(), 'click');
			}
		}
	
//		var coordinate = this.point_to_coordinate(click);
//		$.trace('click', Object.toJSON(coordinate));
//		this.fire(':click', {
//			latitude: coordinate.y,
//			longitude: coordinate.x
//		});
	},
});

Map_Sprite = Class.create({
	DROP_PADDING: 6,

	initialize: function(key) {
		this.key = key;
		this.longitude = 0;
		this.latitude = 0;
		this.hour = 0;
		this.minute = 0;

		this.setup();
	},
	
	setup: function() {
		this.element = new Element('div', { 'class': 'map-marker' })
			.insert(this._content())
			.insert(new Element('div', { 'class': 'pointer' }));

		document.body.insert(this.element);
	},
	
	_content: function() {
		var clock = new Element('div', { 'class': 'clock' })
			.insert(new Element('div', { 'class': 'hour' }))
			.insert(new Element('div', { 'class': 'minute' }));
		var label = new Element('div', { 'class': 'label' });
		return new Element('div', { 'class': 'content' })
			.insert(clock)
			.insert(label);
	},
	
	text: function(v) {
		var el = this.element.down('.label');
		if (v === undefined) return el.innerHTML;
		el.innerHTML = v;
		return this;
	},
	
	time: function(v) {
		if (v === undefined) return { hour: this.hour, minute: this.minute };
		this.hour = v.hour;
		this.minute = v.minute;
		
		var hour_element = this.element.down('.hour');
		var minute_element = this.element.down('.minute');
		var angle = Time.angle_converter.convert(v);
		hour_element.setStyle({
			'-webkit-transform': 'rotate(#{hour}deg)'.interpolate(angle)
		});
		minute_element.setStyle({
			'-webkit-transform': 'rotate(#{minute}deg)'.interpolate(angle)
		});
		
		return this;
	},
	
	position: function() {
		var s = this.size();
		var p = this.element.positionedOffset();
		return { x: p.left + size.x / 2, y: p.top + size.y + this.DROP_PADDING };
	},
	
	location: function(v) {
		if (v === undefined) return { x: this.latitude, y: this.longitude };
		this.latitude = v.x;
		this.longitude = v.y;
		return this;
	},
	
	size: function() {
		var d = this.element.getDimensions();
		return { x: d.width, y: d.height };
	},
	
	move: function(point) {
		var size = this.size();
		this.element.setStyle({
			left: (point.x - size.x / 2) + 'px',
			top: (point.y - size.y + this.DROP_PADDING) + 'px'
		});
	},
	
	hit: function(point) {
		var p = this.element.positionedOffset();
		if (point.x < p.left) return false;
		if (point.y < p.top) return false;

		var d = this.element.getDimensions();
		if (point.x > p.left + d.width) return false;
		if (point.y > p.top + d.height) return false;
		return true;
	}
});

	</script>
<style>
body {
	margin: 0;
	padding: 0;
}

input[type=button] {
	position: fixed;
	bottom: 0;
}


.map-marker {
	position:absolute;
	z-index: 100;
	-webkit-box-align: center;
}

.map-marker>.content {
	min-width: 24px;
	min-height: 18px;
	white-space: nowrap;
	-webkit-border-image: url('map-sprite.png') 12 18 / 12px 18px;
}

.map-marker>.content>.label {
	float:left;
	margin-left: 4px;
	margin-right: -4px;
	font-family: sans-serif;
	font-size: 0.9em;
	font-weight: bold;
	color: #444;
}

.map-marker>.content>.clock {
	float:left;
	margin-top: -6px;
	margin-left: -4px;
	width: 28px;
	height: 28px;
	background: url('map-sprite-clock.png') center center no-repeat;
}

.map-marker>.content>.clock>.minute {
	width: 22px;
	height: 22px;
	opacity: 0.8;
	margin-left: 3px;
	margin-top: -22px;
	-webkit-transform: rotate(180deg);
	background: url('map-sprite-minute.png') center center no-repeat;
}

.map-marker>.content>.clock>.hour {
	width: 22px;
	height: 22px;
	opacity: 0.8;
	margin-left: 2px;
	margin-top: 3px;
	-webkit-transform: rotate(270deg);
	background: url('map-sprite-hour.png') center center no-repeat;
}

.map-marker>.pointer {
	width: 28px;
	height: 14px;
	position: relative;
	bottom: 4px;
	margin: auto;
	background: url('map-sprite-point.png') center center no-repeat;
}

.hbox {
	display: -webkit-box;
	-webkit-box-orient: horizontal;
	-webkit-box-align: stretch;
}
 
.hbox > * {
	-webkit-box-flex: 0;
}

</style>

</head>
<body>
<!--
<div class="sprite">
	<div class="content">
		<div class="clock"><div class="hour"></div><div class="minute"></div></div>
		<div class="label">Seattle</div>
	</div>
	<div class="pointer"></div>
</div>
-->

<canvas id="core-canvas"></canvas><canvas id="seam-canvas"></canvas>


</body>
</html>
