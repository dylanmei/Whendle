<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
	"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Whendle - spotlight</title>
	<!--
	<script src="http://ajax.googleapis.com/ajax/libs/prototype/1.6.0.3/prototype.js" type="text/javascript"></script>
	-->
	<script src="prototype.js" type="text/javascript"></script>
	<script src="../whendle/api/whendle.js" type="text/javascript"></script>
	<script src="../whendle/api/time.js" type="text/javascript"></script>
	<script src="../whendle/api/wait.js" type="text/javascript"></script>
	<script src="../whendle/api/place.js" type="text/javascript"></script>
	<script src="../whendle/api/observable.js" type="text/javascript"></script>
	<script src="../whendle/api/tzdata.js" type="text/javascript"></script>
	<script src="../whendle/api/timezone.js" type="text/javascript"></script>
	<script src="../whendle/api/ajax-service.js" type="text/javascript"></script>
	<script src="../whendle/api/timekeeper-service.js" type="text/javascript"></script>
	<script src="../whendle/api/timezone-locator.js" type="text/javascript"></script>
	<script src="../whendle/api/timezone-repository.js" type="text/javascript"></script>
	<script src="../whendle/api/place-repository.js" type="text/javascript"></script>
	<script src="../whendle/api/spotlight.js" type="text/javascript"></script>
	<script src="database-service.js" type="text/javascript"></script>
	<script src="system-service.js" type="text/javascript"></script>
	<script>

$.trace = function() { console.log($A(arguments).join(' ')); }

document.tzone = 'America/Los_Angeles';
document.tformat = 'HH12';
document.tzpath = '../whendle/tzdata'; // firefox set ~ security.fileuri.strict_origin_policy = false
document.places = [
	  { id: 1, name: 'Seattle', admin: 'Washington', country: 'United States', latitude: 47.6, longitude: -122.3, timezone: 'America/Los_Angeles' }
	, { id: 2, name: 'Sao Paulo', admin: 'Sao Paulo', country: 'Brazil', latitude: -23.5, longitude: -46.6, timezone: 'America/Sao_Paulo' }
	, { id: 3, name: 'London', admin: 'England', country: 'United Kingdom', latitude: 51.5, longitude: -0.12, timezone: 'Europe/London' }
	, { id: 4, name: 'Berlin', admin: 'Berlin', country: 'Germany', latitude: 52.51, longitude: 13.4, timezone: 'Europe/Berlin' }
	, { id: 5, name: 'Shanghai', admin: 'Shanghai', country: 'China', latitude: 31.2, longitude: 121.4, timezone: 'Asia/Shanghai' }
	, { id: 6, name: 'Sydney', admin: 'New South Wales', country: 'Australia', latitude: -33.8, longitude: 151.2, timezone: 'Australia/Sydney' }
	, { id: 7, name: 'Mexico City', admin: 'The Federal District', country: 'Mexico', latitude: 19.26, longitude: -99.8, timezone: 'America/Mexico_City' }
	, { id: 8, name: 'Ottawa', admin: 'Ontario', country: 'Canada', latitude: 45.25, longitude: -75.43, timezone: 'America/Toronto' }
	, { id: 9, name: 'Johannesburg', admin: 'Gauteng', country: 'South Africa', latitude: -26.08, longitude: 27.54, timezone: 'Africa/Johannesburg' }
	, { id: 10, name: 'Tokyo', admin: 'Tokyo', country: 'Japan', latitude: 35.41, longitude: 139.44, timezone: 'Asia/Tokyo' }
];

document.observe('dom:loaded', function() {

	document.system = new SystemService(document.tzone, document.tformat);
	var timekeeper = new Whendle.TimekeeperService(document.system,
		new Whendle.Timezone_Repository(new Whendle.TzLoader(new Whendle.AjaxService(), document.tzpath)));

	timekeeper.setup(function() {
		document.spotlight = new Spotlight(
			timekeeper,
			new Whendle.Place_Repository(new DatabaseService())
		);

		timekeeper.start(new Whendle.Timer(window));
	});
});

//
//	Spotlight
//

Spotlight = Class.create(Whendle.Spotlight.View, {
	initialize: function($super, timekeeper, place_repository) {
		$super();
		this.presenter = new Whendle.Spotlight.Presenter(this,
			timekeeper,
			place_repository
		);

		this.setup();
		this.load(1);
	},
	
	setup: function() {
		this.page = new Page($('spotlight'));
	},
	
	load: function(id) {
		this.fire(Whendle.Event.loading, { 'id': id });
	},
	
	loaded: function(event) {
		this.write_header(event.clock);
	},
	
	write_header: function(clock) {
		this.page.title(clock.title);
		this.page.subtitle(clock.subtitle);
		this.page.time(clock.display);
		this.page.day(clock.day);
	},
	
	unloaded: function() {
	},
	
	changed: function(event) {
		this.write_header(event.clock);
	}
});

Page = Class.create(Whendle.Observable, {
	initialize: function($super, element) {
		$super();
		this.element = element;
		this.setup();
	},
	
	setup: function() {
		$('options').observe('click', this.on_options_click.bind(this));
		$('finder').observe('click', this.on_finder_click.bind(this));
		$('formatter').observe('click', this.on_formatter_click.bind(this));
		
		var self = this;
		document.places.each(function(p) {
			self.add_place_to_finder(p.name);
		});			
	},

	add_place_to_finder: function(name) {
		var li = new Element('li');
		li.innerHTML = name;
		$('finder').insert(li);	
	},
	
	on_options_click: function(event) {
		var link = event.findElement('.link');
		if (link) {
			
			var el = null;
			if (link.innerHTML == 'location') el = $('finder');
			if (link.innerHTML == 'format') el = $('formatter');
			if (el == null) return;
			if (el.visible()) {
				el.hide();
			}
			else {
				$$('.selection').each(function(el) { el.hide() });
				el.setStyle({
					display: 'block',
					top: (link.viewportOffset().top + 4) + 'px',
					left: (link.viewportOffset().left - 8) + 'px'
				});
			}
		}
	},

	on_finder_click: function(event) {
		var li = event.findElement('li');
		if (li) {
			var place = document.places.find(function(p) {
				return p.name == li.innerHTML;
			});
			
			if (place) {
				document.spotlight.load(place.id);
			}
		}
		$('finder').hide();
	},

	on_formatter_click: function(event) {
		var li = event.findElement('li');
		if (li) {
			var format = li.readAttribute('value');
			document.system.timeformat(format);
		}
		$('formatter').hide();
	},

	title: function(v) {
		$('spotlight-title').innerHTML = v;
	},
	
	subtitle: function(v) {
		$('spotlight-subtitle').innerHTML = v;
	},
	
	time: function(v) {
		$('spotlight-time').innerHTML = v;
	},
	
	day: function(v) {
		$('spotlight-day').innerHTML = v;
	}
	
});

	</script>
	<link href="flex-box.css" media="screen" rel="stylesheet" type="text/css" />
	<style>
.app {
	width: 320px;
	min-height: 400px;
	margin: 40px auto;
	border: 1px solid black;
	background-color: #efefef;
	
	font-family: Verdana, Arial, Helvetica, sans-serif;
}

.header {
	padding: 4px;
	border-bottom: 1px solid #ccc;
}

.drawer-button {
	padding: 4px;
	border-bottom: 1px solid #ccc;
}

.drawer {
	display: none;
	border-bottom: 1px solid #ccc;
	background-color: #666;
}

ul.selection {
	position: absolute;
	z-index: 3;
	margin-left: 0;
	padding: 4px;
	border: 1px solid #999;
	background-color: white;
	-webkit-box-shadow: 2px 2px 2px rgba(0,0,0,0.15);	
	-moz-box-shadow: 2px 2px 2px rgba(0,0,0,0.15);	
}

ul.selection li {
	font-weight: bold;
	padding: 4px;
	color: #393;
	list-style: none;
	display: block;
	line-height: 125%;
	cursor: pointer;
}

ul.selection li.emph {
	color: #55C;
}

#options {
	font-size: 0.8em;
	margin: 10px;
}

#options .link {
	border-bottom: 2px solid #393;
	cursor: pointer;	
}
	</style>
</head>
<body>
<div class="app">
	<div id="list">
		<div id="spotlight">
			<div class="palm-page-header multi-line header">
				<div class="palm-page-header-wrapper hbox">
					<div>
						<div id="spotlight-title"></div>
						<div id="spotlight-subtitle"></div>
					</div>
					<div class="spacer"></div>
					<div>
						<div id="spotlight-time"></div>
						<div id="spotlight-day"></div>
					</div>
				</div>
			</div>

			<div class="palm-list">
				<div class="palm-row drawer-button">
					<div class="palm-row-wrapper">
						<div x-mojo-element="Spinner" id="weather-spinner"></div>
						<div class="left icon spotlight-icon weather"></div>
						<div class="title">Weather</div>
					</div>
				</div>
				
				<div class="drawer" x-mojo-element="Drawer" id="weather-drawer">
					<div class="palm-row">
						<div class="palm-row-wrapper">Weather...</div>
					</div>
				</div>
				
				<div class="palm-row drawer-button first">
					<div class="palm-row-wrapper">
						<div  x-mojo-element="Spinner" id="maps-spinner"></div>
						<div class="left icon spotlight-icon maps"></div>
						<div class="title">Maps</div>
					</div>
				</div>
				
				<div class="drawer" x-mojo-element="Drawer" id="maps-drawer">

					<div class="palm-row">
						<div class="palm-row-wrapper">Maps...</div>
					</div>

				</div>
				
				<div class="palm-row drawer-button">
					<div class="palm-row-wrapper">
						<div x-mojo-element="Spinner" id="pictures-spinner"></div>
						<div class="left icon spotlight-icon pictures"></div>
						<div class="title">Pictures</div>
					</div>
				</div>
				
				<div class="drawer" x-mojo-element="Drawer" id="pictures-drawer">
					
					<div class="palm-row">
						<div class="palm-row-wrapper">Pictures...</div>
					</div>
					
				</div>

				<div class="palm-row drawer-button last">
					<div class="palm-row-wrapper">
						<div x-mojo-element="Spinner" id="twitter-spinner"></div>
						<div class="left icon spotlight-icon twitter"></div>
						<div class="title">Twitter</div>
					</div>
				</div>

				<div class="drawer" x-mojo-element="Drawer" id="twitter-drawer">
					<div class="palm-row">
						<div class="palm-row-wrapper">Twitter...</div>
					</div>
				</div>
			</div>
		</div>
		<div id="options">
			change the <span class="link">location</span>,
			
			change the <span class="link">format</span>
		</div>
	</div>
</div>


<ul id="finder" class="selection" style="display:none;min-width:120px">
</ul>
<ul id="formatter" class="selection" style="display:none;min-width:80px">
	<li value="HH12">12 Hour</li>
	<li value="HH24">24 Hour</li>
</ul>

</body>
</html>
