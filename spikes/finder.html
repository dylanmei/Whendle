<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
	"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Whendle - finder</title>
	<!-- Use Geonames.org to find locations (names, latitude, longitude, timezone) via a text search -->
	<script src="http://ajax.googleapis.com/ajax/libs/prototype/1.6.0.3/prototype.js" type="text/javascript"></script>
	<script src="../whendle/api/whendle.js" type="text/javascript"></script>
	<script src="../whendle/api/observable.js" type="text/javascript"></script>
	<script src="../whendle/api/ajax-service.js" type="text/javascript"></script>
	<script src="../whendle/api/finder.js" type="text/javascript"></script>
	<script src="../whendle/api/location.js" type="text/javascript"></script>
	<script src="../whendle/api/clock.js" type="text/javascript"></script>
	<script>

// USE SAFARI
// DOES NOT WORK IN FIREFOX (violates same-origin policy)
// HAS STOPPED WORKING IN CHROME AS WELL (Refused to get unsafe header "X-JSON")
//URL_SEARCH_BY_NAME = 'http://ws.geonames.org/searchJSON';
URL_TIMEZONE_BY_LOCATION = 'http://ws.geonames.org/timezoneJSON';

$.trace = function() { console.log($A(arguments).join(' ')); }

document.observe('dom:loaded', function() {
	$.view = new View();
});

View = Class.create(Whendle.Finder.View, {
	initialize: function($super) {
		$super();
		new Whendle.Finder.Presenter(this, 
			new Whendle.AjaxService()
		);
			
		this.setup();
	},
	
	setup: function() {
		this._list = this.new_list();
		this._input = this.new_input();
//		this._map = this.new_map();
	},
	
	new_list: function() {
		var list = new List($('list'));
		var self = this;
		
		list.observe(':select', function(event) {
			$.trace(Object.toJSON(event.location));
			//self.fetch_timzone(event.location);
		});
		list.observe(':append', function(event) {
			self.fetch_locations($F('input').strip(), event.index);
		});
		return list;
	},
	
	fetch_timzone: function(location) {
		//$.trace('fetching timezone for: #{latitude} x #{longitude}'
		//	.interpolate(location));
		
		//this.fire(Whendle.Event.adding, { 'location': location });
	},
	
	fetch_locations: function(text, index) {
		index = index || 0;
		$.trace('fetching locations for: #{text} (index=#{index})'
			.interpolate({ 'text': text, 'index': index }));
		
		this.fire(Whendle.Event.searching, { 'start': index, 'query': text });
	},
	
	new_input: function() {
		var input = $('input');
		var self = this;
		var clear_tip = function() {
			input.setValue('')
				.addClassName('active')
				.stopObserving('keydown')	
				.stopObserving('mousedown');	
			
			new Form.Element.Observer('input', 0.5,
				self.on_input_changed.bind(self));
		}
		
		return input
			.observe('keydown', clear_tip)
			.observe('mousedown', clear_tip);
	},
	
	on_input_changed: function() {
		var value = $F('input').strip();
		if (value.length < 4) return;
		
		$.trace('input changed');
		
		if ($('input').timer !== undefined) {
			window.clearTimeout($('input').timer);
		}
		
		var self = this;
		$('input').timer = (
			function(value) {
				delete $('input').timer;
				self.fetch_locations(value);
			}
		).delay(1, value);
	},
	
	new_map: function() {
		var map = new Map();
		return map;
	},
	
	found: function(event) {
		if (event.error) $.trace('error:', Object.toJSON(event.error));

		var list = this._list;
		if (event.index == 0) {
			list.clear();
		}

		list.total(event.total);
		for (var i = 0; i < event.locations.length; i++) {
			list.add(event.locations[i]);
		}
	}
});


List = Class.create(Whendle.Observable, {
	initialize: function($super, container) {
		$super();
		this._container = container;
		this.clear();
	},
	
	clear: function() {
		this._container.childElements()
			.each(function(el) {
				el.stopObserving('click')
				el.remove();
			}
		);
		this._total = 0;
		this._insert_appender();
	},
	
	_insert_appender: function() {
		this._appender = new Element('div', { 'class': 'finder-appender' })
			.insert(this._new_label('finder-row-link', ''))
			.observe('click', this._on_append.bind(this))
			.hide();
		this._container.insert(this._appender);
	},

	_on_append: function() {
		this.fire(':append', { 'index': this.count() });
	},
	
	_on_select: function(location) {
		this.fire(':select', { 'location': location });
	},
	
	add: function(location) {
		var row = new Element('div', { 'class': 'finder-row' })
			.insert(this._new_label('finder-row-name', location.name))
			.insert(this._new_label('finder-row-info', '#{district}, #{country}'.interpolate(location)))
			//.insert(this._new_label('finder-row-info', location.area))
			.insert(this._new_label('finder-row-time', ''));
		row.observe('click', this._on_select.bind(this, location));
		this._insert_row(row);
	},
	
	_new_label: function(class_name, text) {
		var label = new Element('span', { 'class': class_name });
		label.innerHTML = text;
		return label;
	},
	
	_insert_row: function(row) {
		this._appender.insert({ 'before': row });
		this._update_appender();
	},
	
	count: function() {
		return $$('.finder-row').size();
	},
	
	total: function(count) {
		if (arguments.length) {
			this._total = count;
			this._update_appender();
		}
		return this._total;
	},
	
	_update_appender: function() {
		var current_count = this.count();
		var total_remaining = this.total() - current_count;

		this._appender.down('.finder-row-link').innerHTML =
			'#{count} more...'.interpolate({ 'count': total_remaining });
		if (total_remaining > 0) {
			this._appender.show();
		}
		else {
			this._appender.hide();
		}
	}
});

/*

var seattle = new Whendle.Location('Seattle', 'Washington', 'United States', 47.6, -122.3),
var sao_paulo = new Whendle.Location('Sao Paulo', 'Sao Paulo', 'Brazil', -23.5, -46.6),
var london = new Whendle.Location('London', 'England', 'United Kingdom', 51.5, -0.12),
var berlin = new Whendle.Location('Berlin', 'Berlin', 'Germany', 52.51, 13.4),
var shanghai = new Whendle.Location('Shanghai', 'Shanghai', 'China', 31.2, 121.4),
var sydney = new Whendle.Location('Sydney', 'New South Wales', 'Australia', -33.8, 151.2),
var ottawa = new Whendle.Location('Ottawa', 'Ontario', 'Canada', 45.25, -75.43),
var johannesburg = new Whendle.Location('Johannesburg', 'Gauteng', 'South Africa', -26.08, 27.54),
var tokyo = new Whendle.Location('Tokyo', 'Tokyo', 'Japan', 35.41, 139.44)


Map = Class.create({
	IMAGE_FILE: 'map-surface.jpg',
	initialize: function() {

		this.canvas = $('canvas');
		this.container = this.canvas.up();
		
		this.canvas.observe('click',
			this.on_canvas_click.bind(this));
		
		this.img = null;
		this.load(this.draw.bind(this));
		this.location(london.longitude, london.latitude);
	},

	load: function(on_ready) {
		this.img = new Image();
		this.img.onload = on_ready;
		this.img.src = this.IMAGE_FILE;
	},
	
	location: function(longitude, latitude) {

		// do our best to center this without the
		// y-component pushing us past the bounds
		// of the map

		this.latitude = latitude;
		this.longitude = longitude;

		var offset = this.map_offset();
		$.trace('latitude/y', this.latitude, offset.y);
		$.trace('longitude/x', this.longitude, offset.x);

		if (this.img != null)
			this.draw();
	},
	
	longitude_to_x: function(longitude) {
		var x = longitude * this.scale().x;
		return x + this.origin().x;
	},
	
	latitude_to_y: function(latitude) {
		var y = latitude * this.scale().x;
		return this.origin().y - y;
	},
	
	x_to_longitude: function(x) {
		x = x - this.origin().x;
		var longitude = x / this.scale().x;
		return longitude;
	},
	
	y_to_latitude: function(y) {
		y = this.origin().y - y;
		var latitude = y / this.scale().y;
		return latitude;
	},

	extent: function() {
		return {
			x: 520,
			y: 260
		}
	},
	
	viewport: function() {
		return {
			x: this.canvas.width,
			y: this.canvas.height
		}
	},
	
	origin: function() {
		var extent = this.extent();
		return {
			x: extent.x / 2,
			y: extent.y / 2
		}
	},
	
	scale: function() {
		var extent = this.extent();
		return {
			x: extent.x / 360,
			y: extent.y / 180
		}
	},
	

	move: function(x, y) {
		this.canvas.setStyle({
			position: 'relative',
			left: x + 'px',
			top: y + 'px'
		});
	},
	

	draw: function() {
		var ctx = this.canvas.getContext('2d');
		this.draw_background(ctx);
		this.draw_map(ctx, this.img);
		this.draw_location(ctx, this.latitude, this.longitude);
		this.draw_container(ctx);
	},
	
	draw_map: function(ctx, map) {
		var extent = this.extent();
		var viewport = this.viewport();
		var image = this.map_offset();
		var x = Math.floor(image.x);
		var y = Math.floor(image.y);

		ctx.drawImage(map, x, y,
			extent.x,
			extent.y
		);
		
		if (image.x > 0) {
			ctx.drawImage(map,
				x - extent.x,
				y,
				extent.x,
				extent.y
			);
		}

		if (image.x + extent.x < viewport.x) {
			ctx.drawImage(map,
				x + extent.x,
				y,
				extent.x,
				extent.y
			);
		}
	},
	
	map_offset: function() {
		return this.translate_point(
			this.location_to_point(this.latitude, this.longitude)
		);
	},
	
	location_offset: function(latitude, longitude) {
		return this.point_offset(
			this.location_to_point(latitude, longitude)
		);
	},
	
	point_offset: function(point) {
		var offset = this.map_offset();
		return {
			  x: point.x + offset.x
			, y: point.y + offset.y
		}
	},
	
	translate_point: function(point) {
		var viewport = this.viewport();
		var offset = {
			  x: 0
			, y: 0
		};
		
		offset.x -= point.x - (viewport.x / 2);
		offset.y += viewport.y / 2 - point.y;
		return offset;	
	},
	
	location_to_point: function(latitude, longitude) {
		var scale = this.scale();
		var extent = this.extent();
		var point = {
			  x: extent.x / 2
			, y: extent.y / 2
		};
		
		point.x += longitude * scale.x;
		point.y -= latitude * scale.y;
		return point;
	},

	draw_location: function(ctx, latitude, longitude) {
		var point = this.location_offset(latitude, longitude);
		this.draw_x(ctx, point.x, point.y);
	},
	
	draw_background: function(ctx) {
		// shouldn't see this....
		var extent = this.viewport();
		ctx.fillStyle = 'rgba(100,100,100,1)';
		ctx.fillRect(0, 0, extent.x, extent.y);
	},
	
	draw_container: function(ctx) {
		var extent = this.viewport();
		
		ctx.lineWidth = 1;
		ctx.strokeStyle = 'rgba(0,0,0,0.7)';
		ctx.beginPath();

		ctx.moveTo(0, 0);
		ctx.lineTo(extent.x, 0);

		ctx.moveTo(0, extent.y);
		ctx.lineTo(extent.x, extent.y);

		ctx.stroke();
	},
	
	on_canvas_click: function(event) {
		var x = event.pointerX();
		var y = event.pointerY();
		var offset = this.canvas.viewportOffset();
		x -= offset.left;
		y -= offset.top;
		
//		$.trace(
//			this.x_to_longitude(x),
//			this.y_to_latitude(y)
//		);
		
//		var x = event.pointerX();
//		var xscale = canvas.width / 360;
//		var xorigin = canvas.width / 2;
		
//		if (document.center != 'sun') {
//			document.tau = (xorigin - x) / xscale;
//		}
//		else {
//			var xoffset = xorigin - x;
//			document.tau += xoffset / xscale;
//		}
		
//		this.fire(':click', {
//			latitude: 0,
//			longitude: tau
//		});
	},
	
	draw_x: function(ctx, x, y) {
		ctx.lineWidth = 1;
		ctx.strokeStyle = 'rgba(255, 0, 0, 0.8)';
		
		ctx.beginPath();
		
		ctx.moveTo(x - 5, y - 5);
		ctx.lineTo(x + 5, y + 5);
		
		ctx.moveTo(x - 5, y + 5);
		ctx.lineTo(x + 5, y - 5);

		ctx.stroke();
	}	
});
*/

	</script>
	
	<style>
.app {
	width: 320px;
	min-height: 400px;
	margin: 40px auto;
	border: 1px solid black;
}
.finder-row, .finder-appender {
	padding: 10px;
	border-bottom: 1px solid #ccc;
	cursor: pointer;
}
.finder-row-name {
	display: block;
	font-size: 1.2em;
	font-weight: bold;
}
.finder-row-info {
	display: block;
	font-size: 0.9em;
}
.finder-row-link {
	color: blue;
}
.finder-row-time {
	position: relative;
	bottom: 30px;
	float: right;
	font-size: 0.9;
}

hr, form {
	margin: 1px 0px;
	padding: 0;
}
input[type=text] {
	border: none;
	width: 95%;
	margin: 0.4em 0.4em;
	color: #666666;
	font-style: italic;
}

input[type=text].active {
	color: black;
	font-style: normal;
}

	</style>
</head>
<body>
<div class="app">
<form onsubmit="return false;">
	<input id="input" type="text" value="Find a location..." />
	<hr />
	<!--
	<canvas id="canvas" width="320" height="180"></canvas>
	-->
</form>
<div id="list">

</div>
</div>
<tt id="trace">
</tt>
</body>
</html>
